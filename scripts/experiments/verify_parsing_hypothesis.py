
import json
import re
from pathlib import Path

# Corrected path: Pipeline outputs to data/output, not data/output/raw_ocr
DATA_DIR = Path("data/output")

def verify_hypothesis():
    print(f"### Verification Report (Full Dataset)\n")
    print(f"| # | File | Status | Ambiguous Lines Analysis |")
    print(f"|---|---|---|---|")

    # Filter for output JSONs ending in _result.json (generated by pipeline)
    json_files = sorted([f for f in DATA_DIR.glob("*_result.json")])

    if not json_files:
        print(f"No result files found in {DATA_DIR}")
        return

    for idx, json_file in enumerate(json_files, 1):
        try:
            with open(json_file, 'r', encoding='utf-8') as f:
                data = json.load(f)
                full_text = data.get("full_text", "")
                
            lines = full_text.split('\n')
            
            issues = []
            
            for line in lines:
                line = line.strip()
                if not line: continue
                
                # Regex for rough price candidates
                matches = re.finditer(r"(-?\d+[.,]\d{2})\s*([A-Za-z0-p*]?)", line) 
                candidates = []
                for m in matches:
                    val = m.group(1)
                    tax = m.group(2)
                    candidates.append(f"{val} {tax}".strip())
                
                if len(candidates) > 1:
                    selected = candidates[-1]
                    issues.append(f"`{line[:40]}...` -> **{selected}** (of {candidates})")

            if not issues:
                status = "✅ OK"
                comment = "No multi-price lines"
            else:
                status = "⚠️ CHECK"
                # Limit output length
                comment = "<br>".join(issues[-3:])
                if len(issues) > 3:
                     comment += f"<br>...and {len(issues)-3} more"

            # Use original filename for cleaner report (remove _result.json)
            original_name = json_file.name.replace("_result.json", ".jpeg")
            print(f"| {idx} | {original_name} | {status} | {comment} |")

        except Exception as e:
            print(f"| {idx} | {json_file.name} | ❌ ERR | {str(e)} |")

if __name__ == "__main__":
    verify_hypothesis()
