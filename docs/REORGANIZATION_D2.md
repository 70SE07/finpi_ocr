# ÐŸÐ»Ð°Ð½ Ñ€ÐµÐ¾Ñ€Ð³Ð°Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð”Ð¾Ð¼ÐµÐ½Ð° 2 (Parsing)

**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** Ð’ Ñ€Ð°Ð±Ð¾Ñ‚Ðµ

---

## Ð¦ÐµÐ»ÑŒ

ÐŸÑ€Ð¸Ð²ÐµÑÑ‚Ð¸ D2 (Parsing) Ð² ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ Ñ ÑƒÑ‚Ð²ÐµÑ€Ð¶Ð´Ñ‘Ð½Ð½Ð¾Ð¹ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð¾Ð¹ (ADR-015) Ð¸ Ð¾Ð±ÐµÑÐ¿ÐµÑ‡Ð¸Ñ‚ÑŒ 100% ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ñ‡ÐµÐºÐ¾Ð² ÑÐ¾Ð³Ð»Ð°ÑÐ½Ð¾ PROJECT_VISION.

---

## ÐŸÑ€Ð¾Ð³Ñ€ÐµÑÑ

- [x] Ð¤Ð°Ð·Ð° 1: Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° stages/
- [x] Ð¤Ð°Ð·Ð° 2: Ð ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑÑ‚Ð°Ð¿Ð¾Ð² Ð¸ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½Ð°
- [x] Ð¤Ð°Ð·Ð° 3: Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ ÑÐ¾ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°Ð¼Ð¸
- [x] Ð¤Ð°Ð·Ð° 4: Checksum Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ (Stage 6)
- [x] Ð¤Ð°Ð·Ð° 5: Ð¡Ñ€Ð°Ð²Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
- [ ] Ð¤Ð°Ð·Ð° 6: ÐÐ²Ð°Ñ€Ð¸Ð¹Ð½Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· Ð¸ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
- [ ] Ð¤Ð°Ð·Ð° 7: Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¿Ð¾ Ð²Ð¸Ð´ÐµÐ½Ð¸ÑŽ

---

## Ð¤Ð°Ð·Ð° 1: Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½Ð°

**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐž

**Ð ÐµÑˆÐµÐ½Ð¸Ðµ:** Ð ÐµÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸Ð·Ð°Ñ†Ð¸Ñ `src/parsing/` Ð¿Ð¾ ADR-015:

```
src/parsing/
â”œâ”€â”€ stages/                    # 6 ÑÑ‚Ð°Ð¿Ð¾Ð² Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½Ð°
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ stage_1_layout.py      # Layout Processing
â”‚   â”œâ”€â”€ stage_2_locale.py      # Locale Detection
â”‚   â”œâ”€â”€ stage_3_store.py       # Store Detection
â”‚   â”œâ”€â”€ stage_4_metadata.py    # Metadata Extraction
â”‚   â”œâ”€â”€ stage_5_semantic.py    # Semantic Extraction (Items)
â”‚   â”œâ”€â”€ stage_6_validation.py  # Validation (Checksum)
â”‚   â””â”€â”€ pipeline.py            # ParsingPipeline (Ð¾Ñ€ÐºÐµÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€)
â”œâ”€â”€ locales/                   # ÐšÐ¾Ð½Ñ„Ð¸Ð³Ð¸ Ð»Ð¾ÐºÐ°Ð»ÐµÐ¹
â””â”€â”€ domain/
    â”œâ”€â”€ interfaces.py          # Ð˜Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÑ‹ ÑÑ‚Ð°Ð¿Ð¾Ð²
    â””â”€â”€ exceptions.py
```

---

## Ð¤Ð°Ð·Ð° 2: ÐšÐ°Ð¶Ð´Ñ‹Ð¹ ÑÑ‚Ð°Ð¿ â€” SRP

**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐž

ÐŸÐ¾ ADR-013 (Clean Code, SRP) ÐºÐ°Ð¶Ð´Ñ‹Ð¹ ÑÑ‚Ð°Ð¿ Ð¸Ð¼ÐµÐµÑ‚:
- Ð¡Ð²Ð¾Ð¹ Ð¦ÐšÐŸ
- Ð•Ð´Ð¸Ð½ÑÑ‚Ð²ÐµÐ½Ð½ÑƒÑŽ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ
- Ð˜Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ (Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ)

```python
# src/parsing/domain/interfaces.py
class ILayoutProcessor(ABC):
    @abstractmethod
    def process(self, raw_ocr: RawOCRResult) -> LayoutResult: ...

class ILocaleDetector(ABC):
    @abstractmethod
    def detect(self, layout: LayoutResult) -> str: ...

class IStoreDetector(ABC):
    @abstractmethod
    def detect(self, layout: LayoutResult, locale_config: LocaleConfig) -> StoreResult | None: ...

# ... Ð¸ Ñ‚Ð°Ðº Ð´Ð°Ð»ÐµÐµ Ð´Ð»Ñ Ð²ÑÐµÑ… 6 ÑÑ‚Ð°Ð¿Ð¾Ð²
```

---

## Ð¤Ð°Ð·Ð° 3: Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ ÑÐ¾ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°Ð¼Ð¸

**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐž

**Ð¡Ð¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹:**
- [x] `scripts/run_d2_pipeline.py` â€” Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº ParsingPipeline
- [x] `scripts/compare_pipelines.py` â€” ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ OLD vs NEW

---

## Ð¤Ð°Ð·Ð° 4: Checksum Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ

**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐž

Stage 6 (Validator) Ð² Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½Ðµ:

```python
class ChecksumValidator:
    TOLERANCE = 0.05  # ADR-011
    
    def validate(self, items: list[Item], receipt_total: float) -> ValidationResult:
        items_sum = sum(item.total for item in items)
        difference = abs(items_sum - receipt_total)
        
        if difference <= self.TOLERANCE:
            return ValidationResult(passed=True, difference=difference)
        else:
            raise ChecksumMismatchError(...)
```

---

## Ð¤Ð°Ð·Ð° 5: Ð¡Ñ€Ð°Ð²Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐž

### Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ (ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ)

| ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° | Stage | Ð ÐµÑˆÐµÐ½Ð¸Ðµ |
|----------|-------|---------|
| Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ð°Ñ ÑÑƒÐ¼Ð¼Ð° Ð½ÐµÐ²ÐµÑ€Ð½Ð°Ñ | Stage 4 | Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ `betrag` Ð² TOTAL_KEYWORDS |
| Ð¡Ñ‚Ñ€Ð¾ÐºÐ¸ Ð²ÐµÑÐ° ÐºÐ°Ðº Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ | Stage 5 | ÐŸÐ°Ñ‚Ñ‚ÐµÑ€Ð½ `WEIGHT_LINE_PATTERNS` |
| Ð¡Ñ‚Ñ€Ð¾ÐºÐ¸ Ð¸Ñ‚Ð¾Ð³Ð¾Ð² ÐºÐ°Ðº Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ | Stage 5 | SKIP_KEYWORDS Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½ |
| ÐÐ°Ð»Ð¾Ð³Ð¾Ð²Ñ‹Ðµ ÑÑ‚Ñ€Ð¾ÐºÐ¸ ÐºÐ°Ðº Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ | Stage 5 | ÐŸÐ°Ñ‚Ñ‚ÐµÑ€Ð½ `TAX_LINE_PATTERNS` |
| qty Ð¸Ð· Ñ†ÐµÐ½Ñ‹ (4,29 â†’ qty=29) | Stage 5 | Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½ regex quantity |

### Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹

| Ð§ÐµÐº | Ð›Ð¾ÐºÐ°Ð»ÑŒ | Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ |
|-----|--------|-----------|
| IMG_1292 | de_DE | **PASSED** |
| IMG_1336 | de_DE | **PASSED** |
| IMG_1352 | de_DE | FAILED (diff: 37.02) |
| PL_001 | pl_PL | FAILED (diff: 98.57) |
| PT_001 | pt_PT | FAILED (diff: 0.99) |

---

## Ð¤Ð°Ð·Ð° 6: ÐÐ²Ð°Ñ€Ð¸Ð¹Ð½Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð·

**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** ðŸ”´ Ð’ ÐŸÐ ÐžÐ¦Ð•Ð¡Ð¡Ð•

**ÐŸÑ€Ð¸Ð½Ñ†Ð¸Ð¿:** Ground Truth Ð½ÐµÐ¿Ñ€Ð¸ÐºÐ¾ÑÐ½Ð¾Ð²ÐµÐ½ÐµÐ½. Ð’ÑÐµ FAILED â€” Ð±Ð°Ð³Ð¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹.

| Ð§ÐµÐº | Ð Ð°ÑÑ…Ð¾Ð¶Ð´ÐµÐ½Ð¸Ðµ | ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ |
|-----|-------------|-----------|
| IMG_1352 | +37.02 EUR | ðŸ”´ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜Ð™ |
| PL_001 | +98.57 PLN | ðŸ”´ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜Ð™ |
| PT_001 | +0.99 EUR | ðŸŸ¡ Ð’Ð«Ð¡ÐžÐšÐ˜Ð™ |

**ÐœÐµÑ‚Ð¾Ð´Ð¾Ð»Ð¾Ð³Ð¸Ñ:**
1. ÐŸÐ¾ÑˆÐ°Ð³Ð¾Ð²Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð³Ð¾Ð½ Ñ‡ÐµÑ€ÐµÐ· ÑÑ‚Ð°Ð¿Ñ‹ Ñ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼
2. RCA (Root Cause Analysis) Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ FAILED

---

## Ð¤Ð°Ð·Ð° 7: Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ

**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** ÐŸÐ›ÐÐÐ˜Ð Ð£Ð•Ð¢Ð¡Ð¯

Ð¢ÐµÐºÑƒÑ‰Ð¸Ðµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÑŽÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ checksum. Ð’Ð¸Ð´ÐµÐ½Ð¸Ðµ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ 100% Ð¿Ð¾ Ð²ÑÐµÐ¼ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ°Ð¼:

| ÐœÐµÑ‚Ñ€Ð¸ÐºÐ° | Ð¢Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ðµ |
|---------|------------|
| Checksum | Â±0.05 |
| ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² | 0 Ñ€Ð°ÑÑ…Ð¾Ð¶Ð´ÐµÐ½Ð¸Ð¹ |
| ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² | 1 Ð² 1 |
| Ð¦ÐµÐ½Ñ‹ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² | 0.00 Ñ€Ð°ÑÑ…Ð¾Ð¶Ð´ÐµÐ½Ð¸Ð¹ |

---

## ÐšÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ

D2 Ñ€ÐµÐ¾Ñ€Ð³Ð°Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÐºÐ¾Ð³Ð´Ð°:

1. âœ… **0 FAILED Ñ‚ÐµÑÑ‚Ð¾Ð²** â€” Ð²ÑÐµ Ground Truth Ñ‡ÐµÐºÐ¸ Ð¿Ñ€Ð¾Ñ…Ð¾Ð´ÑÑ‚
2. âœ… **Ð’ÑÐµ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ð²Ð¸Ð´ÐµÐ½Ð¸Ñ** Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÑŽÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸
3. âœ… **Ground Truth Ð½ÐµÐ¿Ñ€Ð¸ÐºÐ¾ÑÐ½Ð¾Ð²ÐµÐ½ÐµÐ½**
4. âœ… **Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ñ** Ð·Ð°Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹
5. âœ… **ÐŸÐ°Ð¹Ð¿Ð»Ð°Ð¹Ð½ D2** = 6 ÑÑ‚Ð°Ð¿Ð¾Ð² (Layoutâ†’Localeâ†’Storeâ†’Metadataâ†’Itemsâ†’Validation)

---

## Ð¡Ð²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹

- [PROJECT_VISION.md](PROJECT_VISION.md) â€” Ñ„Ð¸Ð»Ð¾ÑÐ¾Ñ„Ð¸Ñ 100% ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð°
- [ADR-015](architecture/decisions/015_d2_pipeline_stages.md) â€” ÑÑ‚Ð°Ð¿Ñ‹ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½Ð° D2
- [ADR-013](architecture/decisions/013_clean_code_srp.md) â€” Clean Code Ð¸ SRP
- [ADR-011](architecture/decisions/011_validation_strategy.md) â€” ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ñ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸
- [ADR-009](architecture/decisions/009_d2_quality_guarantees.md) â€” Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ð¸ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° D2
