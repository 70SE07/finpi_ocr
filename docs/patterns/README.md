# Паттерны чеков - Стандарт документирования


---

## Определение

**Паттерн** - это повторяющаяся структурная или форматная особенность чеков, которая:
1. Встречается в нескольких чеках одного магазина/локали
2. Влияет на логику парсинга (D2)
3. Требует специальной обработки в коде

**Цель документирования паттернов:**
- Построить системное решение для D2 (Parsing)
- Избежать костылей под каждый чек
- Обеспечить 100% качество парсинга на 100+ локалях

---

## Категории паттернов

### 1. КРИТИЧНЫЕ (влияют на корректность данных)

| Паттерн | Описание | Пример проблемы |
|---------|----------|-----------------|
| **Десятичный разделитель** | Запятая vs точка | `12,99` vs `12.99` - неверный парсинг суммы |
| **Налоговый класс** | Формат и позиция | `A`, `+A`, `A_`, `*Б` - пропуск или неверное извлечение |
| **Инверсия налогов** | A и B могут быть инвертированы | HIT: A=19%, Lidl: A=7% |
| **Многострочные товары** | Товар на 2-3 строках | Потеря данных или дублирование |
| **Формат даты** | Разные форматы | `31.07.2025`, `2025-07-31`, буддийский календарь |

### 2. ВАЖНЫЕ (влияют на полноту данных)

| Паттерн | Описание | Пример |
|---------|----------|--------|
| **SKU/Код товара** | Позиция и формат | `826945` в начале, `(399)` в скобках |
| **Скидки** | Ключевые слова и формат | `Preisvorteil`, `RABATT 20%`, отрицательные суммы |
| **Pfand/Залог** | Формат и налоговый класс | `Pfand 0,25 M`, `Pfandrückgabe` |
| **Весовые товары** | Формат количества | `1,207 kg x 8,99 EUR/kg` |
| **Позиция количества** | До или после имени | `2 x Butter` vs `Butter x 2` |

### 3. ИНФОРМАЦИОННЫЕ (полезны для анализа)

| Паттерн | Описание | Пример |
|---------|----------|--------|
| **Категории на чеке** | Магазин группирует товары | HIT: `OBST & GEMÜSE` |
| **Структура чека** | Header/Items/Totals/Footer | Где искать итоговую сумму |
| **Валюта** | Символ и позиция | `EUR`, `€`, `PLN` |
| **Ключевые слова** | Итого, оплата, сдача | `Summe`, `SUMA`, `zu zahlen` |

---

## Структура документирования

### Файловая структура

```
docs/patterns/
├── README.md              # Этот файл - стандарт
├── MATRIX.md              # Агрегированная матрица всех паттернов
├── MATRIX.json            # Machine-readable версия
├── CHECKLIST.md           # Чек-лист для анализа новых чеков
├── dto_decisions.md       # Решения по DTO на основе паттернов
└── by_store/              # Детальные паттерны по магазинам
    └── {locale}/
        ├── _index.json    # Индекс локали
        └── {store}.json   # Паттерны магазина
```

### Формат паттерн-файла (by_store/{locale}/{store}.json)

```json
{
  "store": {
    "brand": "Название магазина",
    "type": "Тип (supermarket, discounter, etc.)",
    "locale": "xx_XX"
  },
  
  "sources": {
    "receipt_ids": ["001", "002"],
    "total_receipts": 2,
    "branches": [...]
  },

  "patterns": {
    "number_format": {
      "decimal_separator": "," | ".",
      "thousands_separator": "." | ",",
      "example": "1.234,56"
    },
    
    "tax_class": {
      "format": "single_letter | prefix | suffix | numeric | cyrillic | none",
      "values": ["A", "B"],
      "meaning": { "A": {...}, "B": {...} },
      "position": "end_of_line | start_of_line | in_name",
      "inverted": false
    },
    
    "item_line": {
      "format": "описание формата строки товара",
      "examples": ["..."],
      "quantity_position": "after_name | before_name",
      "multiline": false,
      "lines_per_item": 1
    },
    
    "sku": {
      "present": true | false,
      "format": "digits | parentheses | hash",
      "position": "before_name | after_name",
      "length": "4-6"
    },
    
    "discounts": {
      "format": "separate_line | inline",
      "keywords": ["Preisvorteil", "RABATT"],
      "value_sign": "negative | positive"
    },
    
    "pfand": {
      "present": true | false,
      "keywords": ["Pfand"],
      "tax_class": "M | B | A"
    },
    
    "date_format": {
      "format": "DD.MM.YYYY | YYYY-MM-DD",
      "calendar": "gregorian | buddhist"
    },
    
    "totals": {
      "keywords": ["Summe", "SUMME", "zu zahlen"],
      "format": "keyword value | keyword: value"
    }
  },

  "anomalies": [
    "Описание аномалий и исключений"
  ],

  "notes": [
    "Дополнительные заметки"
  ]
}
```

---

## Связь с Ground Truth

| Аспект | Ground Truth | Patterns |
|--------|--------------|----------|
| **Что содержит** | Эталонные данные чека | Структурные особенности |
| **Формат** | JSON с items, metadata | JSON с patterns |
| **Цель** | Проверка D1 и D2 | Построение логики D2 |
| **Создается** | При анализе каждого чека | При анализе нескольких чеков магазина |

**Правило:** Каждый чек в ground_truth должен иметь поле `notes` с паттернами, которые затем агрегируются в patterns/by_store/.

---

## Процесс работы с паттернами

### При анализе нового чека:

1. Создать ground_truth файл с полем `notes`
2. Зафиксировать все паттерны в `notes`
3. Если магазин новый - создать паттерн-файл в by_store/
4. Если магазин существует - обновить паттерн-файл
5. Обновить MATRIX.md если обнаружен критичный паттерн

### При ревизии существующих чеков:

1. Проверить наличие `notes` в ground_truth
2. Проверить соответствие паттернов в by_store/
3. Добавить недостающие паттерны

---

## Критерии качества

Система паттернов считается качественной если:

1. **Полнота:** Все критичные паттерны задокументированы
2. **Единообразие:** Все файлы следуют стандарту
3. **Актуальность:** Паттерны соответствуют реальным чекам
4. **Доступность:** Новый AI может понять систему из документации

---

## Связанные документы

- [MATRIX.md](MATRIX.md) - агрегированная матрица
- [CHECKLIST.md](CHECKLIST.md) - чек-лист анализа
- [dto_decisions.md](dto_decisions.md) - решения по DTO
- [Ground Truth](../ground_truth/README.md) - эталонные данные
