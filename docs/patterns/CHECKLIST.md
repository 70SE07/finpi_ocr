# Чек-лист анализа паттернов

**Версия:** 1.0  
**Дата:** 2025-12-29

Этот чек-лист гарантирует 100% качество обнаружения и фиксации паттернов при анализе новых чеков.

---

## Часть 1: При анализе НОВОГО чека

### 1.1 Идентификация

- [ ] Определить локаль (страна, язык)
- [ ] Определить магазин (название, тип)
- [ ] Записать адрес
- [ ] Записать дату и время
- [ ] Записать валюту

### 1.2 Критичные паттерны (ОБЯЗАТЕЛЬНО проверить!)

| Паттерн | Проверено | Значение |
|---------|-----------|----------|
| Десятичный разделитель | [ ] | `,` или `.` |
| Налоговый класс | [ ] | формат и позиция |
| Многострочность товаров | [ ] | 1/2/3 строки |
| Позиция количества | [ ] | после/перед именем |
| Формат даты | [ ] | DD.MM.YYYY / другой |
| Календарная система | [ ] | григорианский / буддийский |

### 1.3 Формат товарной строки

- [ ] Записать пример строки товара
- [ ] Определить позицию элементов:
  - SKU (если есть): перед/после имени
  - Количество: перед/после имени
  - Цена за единицу: формат
  - Итоговая цена: позиция
  - Налоговый класс: позиция

### 1.4 Специальные позиции

- [ ] Скидки: ключевые слова, формат
- [ ] Pfand/Залог: если применимо
- [ ] Весовые товары: формат
- [ ] Категории на чеке: если есть

### 1.5 Блок итогов

- [ ] Ключевое слово итога (Summe, SUMA, Total, etc.)
- [ ] Налоговый блок: формат
- [ ] Способ оплаты

---

## Часть 2: Создание ground_truth файла

### Обязательные поля:

```json
{
  "id": "NNN",
  "source_file": "path/to/image.jpeg",
  "locale": "xx_XX",
  "store": { ... },
  "metadata": {
    "date": "...",
    "time": "...",
    "currency": "...",
    "receipt_total": N.NN
  },
  "items": [ ... ],
  "validation": {
    "checksum_method": "...",
    "expected_total": N.NN,
    "discrepancy": 0.00
  },
  "notes": [
    "ОБЯЗАТЕЛЬНО! Список паттернов"
  ]
}
```

### Контрольный список для `notes`:

- [ ] Десятичный разделитель
- [ ] Формат налогового класса
- [ ] Инверсия налогов (если есть)
- [ ] Многострочность (если есть)
- [ ] Формат скидок (если есть)
- [ ] Уникальные особенности

---

## Часть 3: Создание/Обновление паттерн-файла

### Файл: `docs/patterns/by_store/{locale}/{store}.json`

- [ ] store.brand - название магазина
- [ ] store.type - тип (supermarket, discounter, etc.)
- [ ] store.locale - локаль
- [ ] sources.receipt_ids - список ID чеков
- [ ] patterns.number_format - десятичный разделитель
- [ ] patterns.tax_class - формат налогового класса
- [ ] patterns.item_line - формат строки товара
- [ ] patterns.sku - наличие и формат SKU
- [ ] patterns.discounts - формат скидок
- [ ] patterns.date_format - формат даты
- [ ] patterns.totals - ключевые слова итогов
- [ ] anomalies - аномалии и исключения
- [ ] notes - дополнительные заметки

### Обновить индекс локали:

- [ ] `docs/patterns/by_store/{locale}/_index.json` - добавить магазин

---

## Часть 4: Обновление агрегированной документации

### Если обнаружен НОВЫЙ критичный паттерн:

- [ ] Обновить `docs/patterns/MATRIX.md`
- [ ] Обновить `docs/patterns/MATRIX.json`
- [ ] Обновить `docs/locales_analysis/{locale}/_overview.md` (если есть)

### Что считать критичным:

1. Новый десятичный разделитель для локали
2. Новый формат налогового класса
3. Новая инверсия налогов
4. Многострочные товары
5. Новая календарная система
6. Категории на чеке

---

## Часть 5: Валидация качества

### Перед завершением проверить:

- [ ] Ground truth файл создан и заполнен
- [ ] Поле `notes` содержит ВСЕ паттерны
- [ ] Checksum validation пройдена (discrepancy = 0.00)
- [ ] Паттерн-файл создан/обновлен
- [ ] Индекс локали обновлен
- [ ] MATRIX обновлен (если нужно)

---

## Быстрая справка: Критичные паттерны по локалям

| Локаль | Десятичный | Tax Class | Дата | Особенности |
|--------|------------|-----------|------|-------------|
| de_DE | `,` (или `.` CenterShop) | A/B/M/1 | DD.MM.YYYY | Инверсия HIT/Penny |
| pl_PL | `,` (или `.` Orlen) | A_prefix/suffix | DD-MM-YYYY | ISO у Zabka |
| es_ES | `,` | none in line | DD/MM/YYYY | Tax только в блоке IVA |
| pt_PT | `,` | none | DD/MM/YYYY | Категории Continente |
| th_TH | `.` | none | DD/MM/YYYY | Буддийский календарь! |
| uk_UA | `,` | Я | DD.MM.YYYY | Многострочные! |
| cs_CZ | `,` | 1 | DD.MM.YYYY | Zaokrouhlení, 3-line! |
| bg_BG | `.` | *Б | DD.MM.YYYY | Двойная валюта |
| tr_TR | `,` | %rate | DD.MM.YYYY | - |
| en_IN | `.` | GST | DD/MM/YYYY | GST split |

---

## Контакты и ссылки

- Стандарт: [README.md](README.md)
- Матрица: [MATRIX.md](MATRIX.md)
- Ground Truth: [../ground_truth/README.md](../ground_truth/README.md)
