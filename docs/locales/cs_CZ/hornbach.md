# Hornbach (cs_CZ) - ПРОБЛЕМНЫЙ ЧЕК

## Источник
- **Файл:** data/input/cz_001.jpeg
- **Дата анализа:** 2025-12-26
- **Статус:** ПРОБЛЕМНЫЙ - нет шапки чека

## Проблема

**Клиент сфотографировал чек без верхней части (шапки).**

Это важный паттерн проблемных чеков:
- Нельзя определить магазин напрямую
- Нельзя извлечь адрес, DIČ
- Нужен fallback-механизм

## Косвенные признаки для определения

| Признак | Значение | Вывод |
|---------|----------|-------|
| Формат Art/Ean | Присутствует | Вероятно строительный магазин |
| Валюта | CZK | Чехия |
| Формат налога | DPH 21% | Чехия |
| Товары | Строительные | Hornbach/OBI/Bauhaus |
| Структура | Praha 9, Chlumecká | Hornbach Praha |

**Предполагаемый магазин: HORNBACH Praha 9**

## Метаданные чека (что удалось извлечь)

| Поле | Значение |
|------|----------|
| Сеть | (не определено - нет шапки) |
| Адрес | Praha 9, Sídlo: Chlumecká 2398, 198 00 |
| DIČ | CZ47117559 |
| Валюта | CZK |
| Итого | 1 136,00 CZK |
| Время | 18:05:26 |
| Касса | 11/660/7 |
| Чек | 648560 |

## Ground Truth таблица

| # | raw_name | qty | unit | unit_price | total_price | tax |
|---|----------|-----|------|------------|-------------|-----|
| 1 | ÚPRAVA DESEK/MATERIA | 1,000 | Jedvyk | 20,00 | 20,00 | 1 |
| 2 | Papírová taška HORNB | 1 | Kus | 7,00 | 7,00 | 1 |
| 3 | Rouno zakrývací 1x 3 | 1 | Kus | 95,00 | 95,00 | 1 |
| 4 | HYDROIZOLACE JEDNOSL | 1 | Kus | 575,00 | 575,00 | 1 |
| 5 | BUCK BÍLÉ vel. 10"/X | 2 | Pár | 22,00 | 44,00 | 1 |
| 6 | Sedlový úhelník s v | 4 | Kus | 21,00 | 84,00 | 1 |
| 7 | rohový úhelník pozin | 4 | Kus | 19,00 | 76,00 | 1 |
| 8 | STĚRKA VÍCEÚČELOVÁ P | 2 | Kus | 30,00 | 60,00 | 1 |
| 9 | Váleček malířský 12c | 1 | Kus | 59,00 | 59,00 | 1 |
| 10 | Nůž odlamovací 18mm | 1 | Kus | 23,00 | 23,00 | 1 |
| 11 | HAK S METR ZÁVITEM z | 0,020 | kg | 613,00 | 12,26 | 1 |
| 12 | VRUT UNIV. ZH 4,5x20 | 0,099 | kg | 284,00 | 28,12 | 1 |
| 13 | HŘEBÍK STAVEBNÍ ZH 1 | 0,246 | kg | 213,00 | 52,40 | 1 |

## Checksum валидация

```
20,00 + 7,00 + 95,00 + 575,00 + 44,00 + 84,00 + 76,00 + 60,00 + 59,00 + 23,00 + 12,26 + 28,12 + 52,40 = 1135,78

SOUČET [21]: 1135,78 CZK ✓
Zaokrouhlení: +0,22 CZK
K zaplacení: 1136,00 CZK ✓
```

**Расхождение: 0.00** (с учётом округления)

## Паттерны товарных строк

### Тип 1: Штучный товар
```
Art/Ean 4013307334026
      1   Kus    x         95,00
Rouno zakrývací 1x 3                    95,00 1
```
- Art/Ean на отдельной строке
- qty + unit + x + unit_price на второй строке
- Название + total + tax на третьей строке

### Тип 2: Весовой товар
```
Art/Ean 8524
    0,020  kg     x        613,00
HAK S METR ZÁVITEM z                    12,26 1
```
- Дробное количество в kg
- Цена за кг
- Расчёт: 0,020 × 613,00 = 12,26 ✓

### Тип 3: Пары/комплекты
```
Art/Ean 8592390065636
      2   Pár    x         22,00
BUCK BÍLÉ vel. 10"/X                    44,00 1
```
- Unit = Pár (пара)
- 2 × 22,00 = 44,00 ✓

## Tax block

```
           BRUTTO      DPH       NETTO
1  21 %   1135,78    197,12      938,66
```

Проверка: 938,66 × 1.21 = 1135,78 ✓

## Особенности

1. **Многострочный формат** - 3 строки на товар
2. **Единицы измерения:** Kus (штука), Pár (пара), Jedvyk (?), kg
3. **Zaokrouhlení** - округление до целых крон
4. **Весовые товары** - цена за кг × вес
5. **Tax code "1"** (не буква)

## Выводы для проблемных чеков

### Что делать если нет шапки?

1. **Определение локали:**
   - По валюте (CZK)
   - По ключевым словам (Kus, DPH, Zaokrouhlení)
   - По формату чисел

2. **Определение магазина:**
   - По Art/Ean паттерну
   - По типу товаров
   - По DIČ если виден

3. **Валидация:**
   - Checksum всё равно работает
   - Math validation по qty × price = total
   - Sum(items) = Total

### Рекомендация для системы

```python
class ReceiptConfidence:
    FULL = "full"        # Есть шапка, магазин определён
    PARTIAL = "partial"  # Нет шапки, магазин по косвенным признакам
    UNKNOWN = "unknown"  # Нельзя определить

# В DTO добавить:
store_confidence: ReceiptConfidence
```

