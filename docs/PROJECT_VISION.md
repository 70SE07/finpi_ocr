# Finpi OCR - Видение проекта

**Статус:** Утверждено  
**Дата:** 2025-12-30

---

## Что это за проект

**Finpi** - мини-приложение в Telegram для учета личных финансов.

Пользователь отправляет фото чека → система возвращает оцифрованные данные → пользователь анализирует расходы на дашборде.

---

## Пользовательский сценарий

```
1. Пользователь в магазине получает чек
   (23 товара, итого 159,67 EUR)

2. Открывает Telegram → Finpi мини-апп

3. Отправляет фото чека

4. Система обрабатывает:
   Фото → D1 (OCR) → D2 (Parsing) → D3 (Categorization) → Ответ

5. Пользователь получает результат:
   - Сумма чека: 159,67 EUR
   - Товаров: 23
   - Каждый товар с названием, ценой, категорией

6. Переходит на дашборд:
   - Видит все 23 товара
   - Каждый в своей категории
   - Сумма 1 в 1 как на чеке

7. Анализирует и принимает решения

8. Повторяет процесс для каждого чека
```

---

## Почему 100% качество - не опция, а требование

### Это финансовый учет

Пользователь ведет **учет личных финансов**. Любая ошибка = неверные данные для принятия решений.

### Пользователь ДОВЕРЯЕТ системе

Пользователь не перепроверяет каждый чек вручную. Он ожидает что система работает **безупречно**.

### Математика не прощает ошибок

```
На чеке: 159,67 EUR
Система выдала: 159,66 EUR
Разница: 0,01 EUR

Вопрос пользователя: "Куда делся 1 цент?"
Ответ: СИСТЕМА БЕСПОЛЕЗНА
```

### Количество товаров критично

```
На чеке: 23 товара
Система выдала: 22 товара

Вопрос пользователя: "Какой товар потерялся?"
Ответ: СИСТЕМА БЕСПОЛЕЗНА
```

---

## Принцип Zero Tolerance

| Метрика | Допустимое отклонение |
|---------|----------------------|
| Сумма чека | **0.00** |
| Количество товаров | **0** |
| Название товара | **1 в 1** |
| Цена товара | **0.00** |

**Не 0.01%. Не "почти всегда". ВСЕГДА 100%.**

---

## Что это значит для D1 + D2

### D1 (Extraction)

Должен оцифровать **ВСЁ** что написано на чеке. Без потерь.

- Если на чеке "Milch 1,99" → OCR должен вернуть "Milch 1,99"
- Если на чеке 23 строки товаров → OCR должен вернуть 23 строки

### D2 (Parsing)

Должен структурировать данные **1 в 1** как на чеке.

- Если на чеке итого 159,67 → `total_amount: 159.67`
- Если на чеке 23 товара → `items.length == 23`
- Если checksum не сходится → **БАГ СИСТЕМЫ**, не "ошибка чека"

### Валидация Checksum

```
SUM(items.total_price) == receipt_total
```

Это **не опциональная проверка**. Это **гарантия качества**.

Если не сходится = система не готова, нужно доработать.

---

## Нет понятия "проблемный чек"

```
НЕПРАВИЛЬНО:
  "Этот чек сложный, система не справилась"
  "На этом чеке нестандартный формат"
  "OCR не смог прочитать"

ПРАВИЛЬНО:
  "Система пока не поддерживает этот формат"
  "Нужно доработать D2 для этого паттерна"
  "Нужно улучшить pre-processing для этого типа фото"
```

**Каждый "проблемный" чек = точка роста системы.**

---

## Масштаб

- 100+ локалей (страны, языки)
- 10,000+ вариаций чеков (магазины, форматы)
- Каждый чек = 100% качество

Система должна справляться со ВСЕМИ чеками, а не с "большинством".

---

## Фундаментальный принцип: ТОЛЬКО СИСТЕМНЫЕ РЕШЕНИЯ

> **"Мне не нужны решения которые не системны. Мне не нужны костыли для закрытия проблем с конкретным чеком. Мне нужна СИСТЕМА."**

### Суть принципа

**Мы не можем обработать 100,000 чеков и захардкодить каждый.** Это невозможно и не масштабируется.

Мы должны:
1. **Анализировать** конкретные чеки
2. **Выявлять паттерны** (системные закономерности)
3. **Создавать решения на уровне паттернов**

Конкретный чек = **входные данные для анализа**, не объект для хардкода.

### Процесс работы с чеком

```
1. СМОТРИМ на конкретный чек
   (de_DE, Lidl, Mühlenstraße 49, точка в цене вместо запятой)

2. АНАЛИЗИРУЕМ
   "Это особенность ЭТОГО чека или это ПАТТЕРН?"
   
3. ВЫЯВЛЯЕМ паттерн
   "В некоторых немецких магазинах точка вместо запятой"
   
4. СОЗДАЕМ системное решение
   НЕ: if store == "Lidl" and street == "Mühlenstraße 49"
   А: store_config с параметром decimal_separator
   
5. РЕЗУЛЬТАТ
   Решение работает для ВСЕХ магазинов с этим паттерном
```

### Что такое "системное решение"

| Критерий | Костыль | Системное решение |
|----------|---------|-------------------|
| Работает для | 1 конкретного случая | Класса случаев |
| При новой локали | Нужен новый костыль | Добавляем конфиг |
| Масштабируется | Нет | Да |
| Поддерживаемость | Сложно | Просто |

### Примеры

**Костыль (так делать НЕЛЬЗЯ):**
```python
# Фикс для конкретного магазина на конкретной улице
if store == "Lidl" and locale == "de_DE" and "Mühlenstraße" in address:
    price = price.replace(".", ",")
```

**Системное решение (так ПРАВИЛЬНО):**
```python
# Паттерн: магазин может иметь свой десятичный разделитель
# Это конфигурируется, не хардкодится
store_config = get_store_config(store, locale)
decimal_separator = store_config.decimal_separator or locale_config.decimal_separator
price = parse_price(raw_price, decimal_separator)
```

### Тест на системность

Перед принятием любого решения:

```
Вопрос: "Это решение на уровне ПАТТЕРНА или на уровне КОНКРЕТНОГО ЧЕКА?"

Уровень паттерна → Системное решение → ПРИНИМАЕМ
Уровень чека → Костыль → ИЩЕМ ПАТТЕРН
```

### Принцип расширяемости

```
Сегодня: 10 локалей, система работает
Завтра: +1 локаль (Япония)
  
Что делаем:
  1. Анализируем японские чеки
  2. Выявляем паттерны (новые или существующие)
  3. Создаем locale config для ja_JP
  4. Система работает для 11 локалей
  
Чего НЕ делаем:
  - Не переписываем ядро
  - Не добавляем if japan then...
  - Не создаем отдельный парсер для Японии
```

### Резюме

**Мы разрабатываем СИСТЕМУ, а не коллекцию костылей.**

- Конкретный чек = источник информации о паттернах
- Решение = на уровне паттерна, не на уровне чека
- Новая локаль = новый конфиг, не новый код
- 101-я локаль добавляется так же просто как 11-я

---

## Резюме для ИИ-ассистента

При работе над этим проектом помни:

1. **Это финансовый учет** - точность критична
2. **100% качество** - не цель, а требование
3. **0% расхождений** - единственный допустимый результат
4. **Нет "проблемных чеков"** - есть недоработки системы
5. **Каждый чек должен быть обработан** - без исключений

**Если система выдает 159,66 вместо 159,67 - система НЕ РАБОТАЕТ.**

---

## Связанные документы

- `docs/architecture/decisions/002_domain_responsibilities.md` - ЦКП доменов
- `docs/architecture/decisions/009_d2_quality_guarantees.md` - Гарантии качества D2
- `docs/architecture/architecture_overview.md` - Обзор архитектуры
