# MATRIX - Агрегированная матрица OCR-артефактов

## Обзор

| Локаль | Чеков проанализировано | Всего артефактов | Top артефакты |
|---------|----------------------|------------------|----------------|
| de_DE | 1 | 9 | CHAR_MISS (33.3%), CHAR_SUB (22.2%), DIAC_LOSS (11.1%) |
| pl_PL | 1 | 16 | CHAR_SUB (43.8%), GARBAGE (37.5%), DIAC_LOSS (12.5%) |
| th_TH | 0 | 0 | - |
| uk_UA | 0 | 0 | - |
| bg_BG | 0 | 0 | - |

**Всего:** 2 чека, 25 артефактов

---

## По типам артефактов (GLOBAL)

| Тип | de_DE | pl_PL | th_TH | uk_UA | bg_BG | Итого | % от всех |
|-----|--------|-------|--------|--------|--------|-------|-----------|
| CHAR_SUB | 2 | 7 | - | - | - | 9 | 36.0% |
| CHAR_MISS | 3 | 0 | - | - | - | 3 | 12.0% |
| CHAR_EXTRA | - | - | - | - | - | 0 | 0.0% |
| WORD_SPLIT | 1 | 0 | - | - | - | 1 | 4.0% |
| WORD_MERGE | - | 1 | - | - | - | 1 | 4.0% |
| GARBAGE | 1 | 6 | - | - | - | 7 | 28.0% |
| DIAC_LOSS | 1 | 2 | - | - | - | 3 | 12.0% |
| CASE_ERR | - | - | - | - | - | 0 | 0.0% |
| SCRIPT_MIX | - | - | - | - | - | 0 | 0.0% |
| NUM_FMT | - | - | - | - | - | 0 | 0.0% |
| **ИТОГО** | **9** | **16** | **0** | **0** | **0** | **25** | **100%** |

---

## Топ-3 типа артефактов (GLOBAL)

1. **CHAR_SUB (36.0%)** - Замены символов
   - de_DE: `rebe→PRESS`, `Olivenöle→Olivenöl`
   - pl_PL: `C.JOG→C_JOG`, `HEN→MEN`, `CHANPI→CHAMPI`, `Kuota→Kwota`

2. **GARBAGE (28.0%)** - Мусорные символы
   - de_DE: `Bull'sEyeFeink.Honey` (точка)
   - pl_PL: `dul`, `gas`, `fque`, `uqu`, `BYAR`, `sbob b2ysio`

3. **CHAR_MISS / DIAC_LOSS (12.0% каждый)**
   - de_DE: `Hähn.Keulen→Hähnchenkeulen`, `Prosecco rose→Prosecco rosé`
   - pl_PL: `OŚMIORNICA→OSHIORNICA`, `JARMUŻU→JARMUZU`

---

## Универсальные правила очистки

Правила, применимые ко всем локалям:

| ID | Тип | Паттерн | Замена | Уверенность | Описание |
|----|-----|----------|---------|------------|----------|
| UNIV_001 | GARBAGE | `^(dul\|gas\|fque)\\n` | `` | 0.95 | Удалить мусор в header |
| UNIV_002 | GARBAGE | `\\n(uqu\|BYAR)\\n` | `\\n` | 0.95 | Удалить мусор между строками |
| UNIV_003 | WORD_MERGE | `([A-Za-z])\\.([A-Z])` | `$1 $2` | 0.90 | Разделить слова по точке |

---

## Locale-specific правила

### de_DE (9 артефактов)

| ID | Тип | Паттерн | Замена | Уверенность | Примеры |
|----|-----|----------|---------|------------|----------|
| de_DE_001 | CHAR_SUB | `^rebe$` | `PRESS` | 0.90 | header context |
| de_DE_002 | CHAR_MISS | `Hähn\\.Keulen` | `Hähnchenkeulen` | 0.80 | . → chen |
| de_DE_003 | DIAC_LOSS | `rose$` | `rosé` | 0.90 | Prosecco |
| de_DE_004 | CHAR_SUB | `Olivenöle` | `Olivenöl` | 0.95 | dictionary |
| de_DE_005 | GARBAGE | `\\.Honey` | ` Honey` | 0.95 | split words |

### pl_PL (16 артефактов)

| ID | Тип | Паттерн | Замена | Уверенность | Примеры |
|----|-----|----------|---------|------------|----------|
| pl_PL_001 | DIAC_LOSS | `OSHIORNICA` | `OŚMIORNICA` | 0.95 | Ś→SH |
| pl_PL_002 | DIAC_LOSS | `JARMUZU` | `JARMUŻU` | 0.95 | Ż→Z |
| pl_PL_003 | CHAR_SUB | `^([AC])\\.` | `$1_` | 0.95 | tax prefix . → _ |
| pl_PL_004 | CHAR_SUB | `^([AC]) ` | `$1_` | 0.95 | tax prefix space → _ |
| pl_PL_005 | CHAR_SUB | `^CMC` | `C_MC` | 0.90 | restore underscore |
| pl_PL_006 | CHAR_SUB | `HEN$` | `MEN` | 0.85 | H→M in product |
| pl_PL_007 | CHAR_SUB | `CHANPI` | `CHAMPI` | 0.85 | N→M in product |
| pl_PL_008 | CHAR_SUB | `KARTAPIATNI` | `KARTAPŁATNI` | 0.90 | restore Ł |
| pl_PL_009 | CHAR_SUB | `Kuota` | `Kwota` | 0.95 | u→w |
| pl_PL_010 | WORD_MERGE | `LUZJAVA` | `LUZ` | 0.85 | remove garbage suffix |
| pl_PL_011 | GARBAGE | `sbob b2ysio` | `` | 0.95 | remove garbage |

---

## Детальный анализ по локалям

### de_DE (1 чек, 9 артефактов)

**Проанализированный чек:** IMG_1292 (Lidl)

**Статистика:**
- Слов в OCR: 358
- Артефактов найдено: 9
- Частость артефактов: 2.5%

**Особенности немецких чеков:**
- Диакритика (ä, ö, ü, ß) обычно распознается хорошо
- Редкие проблемы с é (французские заимствования)
- Пропуски символов в длинных словах

### pl_PL (1 чек, 16 артефактов)

**Проанализированный чек:** PL_001 (Carrefour)

**Статистика:**
- Слов в OCR: 359
- Артефактов найдено: 16
- Частость артефактов: 4.5% (почти в 2 раза выше чем de_DE!)

**Особенности польских чеков:**
- Tax prefix (A_, C_) часто распознается неверно: `_` → `.` или ` ` или теряется
- Польская диакритика проблемна: `Ś→SH`, `Ż→Z`, `Ł→L/I`
- Много мусорных символов в header и между товарами

**Критические правила для pl_PL:**
1. Восстановление `_` в tax prefix
2. Словарная коррекция польской диакритики
3. Фильтрация мусора

---

## Сравнение локалей

| Метрика | de_DE | pl_PL | Вывод |
|---------|--------|-------|-------|
| Частость артефактов | 2.5% | 4.5% | pl_PL сложнее для OCR |
| Топ-1 артефакт | CHAR_MISS (33%) | CHAR_SUB (44%) | Разные типы проблем |
| GARBAGE | 11% | 38% | pl_PL имеет больше мусора |
| DIAC_LOSS | 11% | 13% | Похожий уровень |

**Вывод:** Польские чеки требуют больше очистки, особенно:
- Tax prefix нормализация
- Удаление мусора
- Словарная коррекция диакритики

---

## Последнее обновление

Дата: 2025-01-03
Статус: В процессе

**Прогресс:**
- de_DE: 1/10 чеков (10%) - нужно ещё 9+
- pl_PL: 1/10 чеков (10%) - нужно ещё 9+
- th_TH: 0/10 чеков (0%)
- uk_UA: 0/10 чеков (0%)
- bg_BG: 0/10 чеков (0%)

**Общий прогресс:** 2/50 чеков (4%)

---

## Критерии готовности к реализации s1_ocr_cleanup

### Минимальные критерии (для MVP)

- [x] 2+ локали проанализировано
- [x] 10+ уникальных паттернов найдено (есть 25)
- [x] TOP-5 паттернов задокументировано с правилами
- [x] Универсальные правила выделены
- [x] Locale-specific правила задокументированы

### Рекомендуемые критерии (для Production)

- [ ] 10+ чеков на локаль
- [ ] 3+ локали с нелатинским скриптом (th_TH, uk_UA, bg_BG)
- [ ] A/B тестирование правил

---

## Связанные документы

- [ARTIFACT_TYPES.md](ARTIFACT_TYPES.md) - классификатор артефактов
- [CLEANUP_RULES.md](CLEANUP_RULES.md) - правила для реализации
- [by_locale/](by_locale/) - детальные артефакты по локалям
- [README.md](README.md) - методология анализа
