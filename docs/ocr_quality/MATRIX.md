# MATRIX - Агрегированная матрица OCR-артефактов

## Обзор

| Локаль | Чеков проанализировано | Всего артефактов | Top артефакты |
|---------|----------------------|------------------|----------------|
| de_DE | 13 | 17 | GARBAGE (41.2%), WORD_SPLIT (35.3%), CHAR_SUB (11.8%) |
| pl_PL | 1 | 16 | CHAR_SUB (43.8%), GARBAGE (37.5%), DIAC_LOSS (12.5%) |
| th_TH | 0 | 0 | - |
| uk_UA | 0 | 0 | - |
| bg_BG | 0 | 0 | - |
| cs_CZ | 0 | 0 | - |
| es_ES | 0 | 0 | - |
| pt_PT | 0 | 0 | - |
| tr_TR | 0 | 0 | - |

**Всего:** 14 чеков, 33 артефакта

---

## По типам артефактов (GLOBAL)

| Тип | de_DE | pl_PL | th_TH | uk_UA | bg_BG | cs_CZ | es_ES | pt_PT | tr_TR | Итого | % от всех |
|-----|--------|-------|--------|--------|--------|--------|--------|--------|--------|-------|-----------|
| CHAR_SUB | 2 | 7 | - | - | - | - | - | - | - | 9 | 27.3% |
| CHAR_MISS | 1 | 0 | - | - | - | - | - | - | - | 1 | 3.0% |
| CHAR_EXTRA | - | - | - | - | - | - | - | - | - | 0 | 0.0% |
| WORD_SPLIT | 6 | 0 | - | - | - | - | - | - | - | 6 | 18.2% |
| WORD_MERGE | - | 1 | - | - | - | - | - | - | - | 1 | 3.0% |
| GARBAGE | 7 | 6 | - | - | - | - | - | - | - | 13 | 39.4% |
| DIAC_LOSS | 1 | 2 | - | - | - | - | - | - | - | 3 | 9.1% |
| CASE_ERR | - | - | - | - | - | - | - | - | - | 0 | 0.0% |
| SCRIPT_MIX | - | - | - | - | - | - | - | - | - | 0 | 0.0% |
| NUM_FMT | - | - | - | - | - | - | - | - | - | 0 | 0.0% |
| **ИТОГО** | **17** | **16** | **0** | **0** | **0** | **0** | **0** | **0** | **0** | **33** | **100%** |

---

## Топ-3 типа артефактов (GLOBAL)

1. **GARBAGE (39.4%)** - Мусорные символы
   - de_DE: Множественные звёздочки `*******`, `***`, `***************`
   - pl_PL: `dul`, `gas`, `fque`, `uqu`, `BYAR`, `sbob b2ysio`

2. **CHAR_SUB (27.3%)** - Замены символов
   - de_DE: `rebe→PRESS`, `Olivenöle→Olivenöl`
   - pl_PL: `C.JOG→C_JOG`, `HEN→MEN`, `CHANPI→CHAMPI`, `Kuota→Kwota`

3. **WORD_SPLIT (18.2%)** - Слова не найдены в OCR
   - de_DE: `Bio Olivenöl`, `F&G Häh Min.schri`, `Lemonaid Limette`, `Red Bull 0,25l`, `Xoxo Waterm.0,33l-`

---

## Универсальные правила очистки

Правила, применимые ко всем локалям:

| ID | Тип | Паттерн | Замена | Уверенность | Описание |
|----|-----|----------|---------|------------|----------|
| UNIV_001 | GARBAGE | `^(dul\|gas\|fque)\n` | `` | 0.95 | Удалить мусор в header |
| UNIV_002 | GARBAGE | `\n(uqu\|BYAR)\n` | `\n` | 0.95 | Удалить мусор между строками |
| UNIV_003 | WORD_MERGE | `([A-Za-z])\.([A-Z])` | `$1 $2` | 0.90 | Разделить слова по точке |
| UNIV_004 | GARBAGE | `\*{3,}` | `` | 1.00 | Удалить множественные звёздочки (3 и более) |

---

## Locale-specific правила

### de_DE (13 чеков, 17 артефактов)

| ID | Тип | Паттерн | Замена | Уверенность | Примеры |
|----|-----|----------|---------|------------|----------|
| de_DE_001 | GARBAGE | `\*{3,}` | `` | 1.00 | Множественные звёздочки |
| de_DE_002 | CHAR_MISS | `Hähn\.Keulen` | `Hähnchenkeulen` | 0.80 | . → chen |
| de_DE_003 | DIAC_LOSS | `rose$` | `rosé` | 0.90 | Prosecco |
| de_DE_004 | CHAR_SUB | `Olivenöle` | `Olivenöl` | 0.95 | dictionary |
| de_DE_005 | CHAR_SUB | `^rebe$` | `PRESS` | 0.90 | header context |

### pl_PL (1 чек, 16 артефактов)

| ID | Тип | Паттерн | Замена | Уверенность | Примеры |
|----|-----|----------|---------|------------|----------|
| pl_PL_001 | DIAC_LOSS | `OSHIORNICA` | `OŚMIORNICA` | 0.95 | Ś→SH |
| pl_PL_002 | DIAC_LOSS | `JARMUZU` | `JARMUŻU` | 0.95 | Ż→Z |
| pl_PL_003 | CHAR_SUB | `^([AC])\.` | `$1_` | 0.95 | tax prefix . → _ |
| pl_PL_004 | CHAR_SUB | `^([AC]) ` | `$1_` | 0.95 | tax prefix space → _ |
| pl_PL_005 | CHAR_SUB | `^CMC` | `C_MC` | 0.90 | restore underscore |
| pl_PL_006 | CHAR_SUB | `HEN$` | `MEN` | 0.85 | H→M in product |
| pl_PL_007 | CHAR_SUB | `CHANPI` | `CHAMPI` | 0.85 | N→M in product |
| pl_PL_008 | CHAR_SUB | `KARTAPIATNI` | `KARTAPŁATNI` | 0.90 | restore Ł |
| pl_PL_009 | CHAR_SUB | `Kuota` | `Kwota` | 0.95 | u→w |
| pl_PL_010 | WORD_MERGE | `LUZJAVA` | `LUZ` | 0.85 | remove garbage suffix |
| pl_PL_011 | GARBAGE | `sbob b2ysio` | `` | 0.95 | remove garbage |

---

## Детальный анализ по локалям

### de_DE (13 чеков, 17 артефактов)

**Проанализированные чеки:**
- 001_de_DE_lidl_IMG_1292 (Lidl)
- 003_de_DE_netto_IMG_1256 (Netto)
- 004_de_DE_lidl_IMG_1390 (Lidl)
- 006_de_DE_baeckerei_IMG_2034 (Bäckerei)
- 007_de_DE_kleins_IMG_3185 (Kleins)
- 008_de_DE_aldi_IMG_1724 (Aldi)
- 009_de_DE_aldi_IMG_2529 (Aldi)
- 010_de_DE_centershop_IMG_1400 (Centershop)
- 011_de_DE_dm_IMG_2727 (DM)
- 012_de_DE_edeka_IMG_1331 (Edeka)
- 013_de_DE_edeka_IMG_1525 (Edeka)
- 014_de_DE_edeka_IMG_1896 (Edeka)
- 015_de_DE_edeka_IMG_1931 (Edeka)

**Статистика:**
- Слов в OCR: 2681
- Артефактов найдено: 17
- Частость артефактов: 0.6%

**Особенности немецких чеков:**
- Диакритика (ä, ö, ü, ß) обычно распознаётся хорошо
- Редкие проблемы с é (французские заимствования)
- Пропуски символов в длинных словах
- Множественные звёздочки (GARBAGE) - самый распространённый артефакт (41.2%)
- WORD_SPLIT (35.3%) - слова не найдены в OCR (возможно разорваны на части)

**Критические правила для de_DE:**
1. Удаление множественных звёздочек (3+ символов подряд)
2. Проверка слов, которые не найдены в OCR (WORD_SPLIT) - требуется визуальная проверка
3. Словарная коррекция символов (CHAR_SUB, CHAR_MISS)
4. Восстановление диакритики (DIAC_LOSS)

### pl_PL (1 чек, 16 артефактов)

**Проанализированный чек:** PL_001 (Carrefour)

**Статистика:**
- Слов в OCR: 359
- Артефактов найдено: 16
- Частость артефактов: 4.5% (почти в 8 раз выше чем de_DE!)

**Особенности польских чеков:**
- Tax prefix (A_, C_) часто распознаётся неверно: `_` → `.` или ` ` или теряется
- Польская диакритика проблемна: `Ś→SH`, `Ż→Z`, `Ł→L/I`
- Много мусорных символов в header и между товарами

**Критические правила для pl_PL:**
1. Восстановление `_` в tax prefix
2. Словарная коррекция польской диакритики
3. Фильтрация мусора

---

## Сравнение локалей

| Метрика | de_DE | pl_PL | Вывод |
|---------|--------|-------|-------|
| Частость артефактов | 0.6% | 4.5% | pl_PL сложнее для OCR |
| Топ-1 артефакт | GARBAGE (41%) | CHAR_SUB (44%) | Разные типы проблем |
| GARBAGE | 41% | 38% | Похожий уровень |
| DIAC_LOSS | 6% | 13% | pl_PL больше |
| WORD_SPLIT | 35% | 0% | de_DE имеет WORD_SPLIT проблемы |

**Вывод:** Польские чеки требуют больше очистки, особенно:
- Tax prefix нормализация
- Удаление мусора
- Словарная коррекция диакритики

---

## Последнее обновление

Дата: 2026-01-03
Статус: Активный анализ

**Прогресс:**
- de_DE: 13/13 чеков (100%)
- pl_PL: 1/10 чеков (10%) - нужно ещё 9+
- th_TH: 0/10 чеков (0%)
- uk_UA: 0/10 чеков (0%)
- bg_BG: 0/10 чеков (0%)
- cs_CZ: 0/10 чеков (0%)
- es_ES: 0/10 чеков (0%)
- pt_PT: 0/10 чеков (0%)
- tr_TR: 0/10 чеков (0%)

**Общий прогресс:** 14/80 чеков (17.5%)

---

## Критерии готовности к реализации s1_ocr_cleanup

### Минимальные критерии (для MVP)

- [x] 2+ локали проанализировано
- [x] 10+ уникальных паттернов найдено (есть 17)
- [x] TOP-5 паттернов задокументировано с правилами
- [x] Универсальные правила выделены
- [x] Locale-specific правила задокументированы

### Рекомендуемые критерии (для Production)

- [x] 10+ чеков на локаль (de_DE: 13/10)
- [ ] 3+ локали с нелатинским скриптом (th_TH, uk_UA, bg_BG)
- [ ] A/B тестирование правил

---

## Связанные документы

- [ARTIFACT_TYPES.md](ARTIFACT_TYPES.md) - классификатор артефактов
- [CLEANUP_RULES.md](CLEANUP_RULES.md) - правила для реализации
- [by_locale/](by_locale/) - детальные артефакты по локалям
- [README.md](README.md) - методология анализа
