# Классификация OCR-артефактов

Документ определяет систематическую классификацию ошибок распознавания текста (OCR) для реализации Stage 1: OCR Cleanup.

---

## Классификатор артефактов

| Категория | Код | Описание | Пример | Причина |
|-----------|-----|----------|--------|---------|
| Character Substitution | `CHAR_SUB` | Замена похожих символов | `0` vs `O`, `l` vs `1` | Визуальное сходство |
| Character Missing | `CHAR_MISS` | Пропуск символов | `LIDL` → `LDL` | Низкое качество изображения |
| Character Extra | `CHAR_EXTRA` | Лишние символы | `LIDL` → `LIIDL` | Шум, артефакты сканирования |
| Word Split | `WORD_SPLIT` | Разрыв слова | `LIDL` → `LI DL` | Пробелы или разрывы на чеке |
| Word Merge | `WORD_MERGE` | Склейка слов | `LIDL 6,99` → `LIDL6,99` | Отсутствие пробелов |
| Garbage Symbols | `GARBAGE` | Мусорные символы | `***`, `|||`, `~~~` | Линии, рамки, декоративные элементы |
| Diacritics Loss | `DIAC_LOSS` | Потеря диакритики | `ś` → `s`, `ě` → `e` | Низкое разрешение, проблемы с Unicode |
| Case Error | `CASE_ERR` | Ошибка регистра | `Lidl` → `LIDL` или `lidl` | Несоответствие шаблону |
| Script Confusion | `SCRIPT_MIX` | Смешение алфавитов | Латинская `i` vs Кириллица `і` | Подобие визуальное или кодовое |
| Number Format | `NUM_FMT` | Ошибка в числах | `6,99` → `6.99` или `699` | Неверный разделитель, потеря символов |

---

## Детальное описание каждого типа

### 1. Character Substitution (CHAR_SUB)

Замена символов, которые визуально похожи.

**Подтипы:**
- `O/0`: `0livenöle` вместо `Olivenöle`
- `l/1`: `L1DL` вместо `LIDL`
- `S/5`: `5cheine` вместо `Schweine`
- `I/l`: `LIDl` вместо `LIDL`

**Контекст-зависимые правила:**
- `0` → `O` в начале слова перед строчной буквой
- `1` → `l` внутри слова
- `5` → `S` в начале слова перед `ch`, `sp`

### 2. Character Missing (CHAR_MISS)

Полная потеря одного или нескольких символов.

**Подтипы:**
- Внутри слова: `LDL` вместо `LIDL`
- В конце слова: `Butte` вместо `Butter`
- В начале слова: `idl` вместо `Lidl`

**Причины:**
- Размытое изображение
- Перекрытие соседних элементов
- Шум на краю чека

### 3. Character Extra (CHAR_EXTRA)

Добавление лишних символов.

**Подтипы:**
- Дублирование: `LLIDL` вместо `LIDL`
- Вставка мусора: `LID-L` вместо `LIDL`
- Лишние пробелы: `LID  L` вместо `LIDL`

### 4. Word Split (WORD_SPLIT)

Слово разделено на части пробелом или разрывом.

**Подтипы:**
- По пробелу: `LI DL` вместо `LIDL`
- По символу: `LI-DL` вместо `LIDL`
- По разрыву строки: `LI\nDL`

**Причины:**
- Линии форматирования на чеке
- Разрывы в принтере
- Низкий контраст между сегментами слова

### 5. Word Merge (WORD_MERGE)

Два или более слов склеены без разделителя.

**Подтипы:**
- Товар + цена: `LIDL6,99` вместо `LIDL 6,99`
- Название + модификатор: `Olivenölenatur` вместо `Olivenöl natur`
- Кол-во + название: `2xBrot` вместо `2x Brot`

**Причины:**
- Компактная верстка
- Отсутствие пробелов в шаблоне чека

### 6. Garbage Symbols (GARBAGE)

Символы, которые не относятся к тексту.

**Подтипы:**
- Разделительные линии: `---`, `===`, `***`
- Декоративные символы: `|||`, `~~~`, `>>>`
- Технические метки: `*`, `#`, `@`, `|`, `\`

**Маскированный мусор:**
- `H***@` - частичная маскировка текста
- `H****9` - нечитаемые символы заменены звёздочками

### 7. Diacritics Loss (DIAC_LOSS)

Потеря диакритических знаков.

**По локалям:**

| Локаль | Диакритика | Пример потери |
|---------|-----------|--------------|
| pl_PL | ą, ć, ę, ł, ń, ó, ś, ź, ż | `CZEKOLADKA` → `CZEKOLADKA` |
| cs_CZ | á, č, ď, é, ě, í, ň, ó, ř, š, ť, ú, ů, ý, ž | `STERKA` → `STĚRKA` |
| de_DE | ä, ö, ü, ß | `Olivenole` → `Olivenöl` |
| es_ES | á, é, í, ó, ú, ü, ñ, ç | `NARANJA` → `NARANJA` |

### 8. Case Error (CASE_ERR)

Несоответствие ожидаемого регистра.

**Подтипы:**
- All UPPERCASE: `LIDL` вместо `Lidl` (если эталон - lowercase)
- All lowercase: `lidl` вместо `Lidl` (если эталон - uppercase)
- Смешанный: `LiDl` вместо `Lidl`

**Примечание:** Некоторые чеки намеренно используют UPPERCASE для заголовков.

### 9. Script Confusion (SCRIPT_MIX)

Смешение алфавитов с визуально похожими символами.

**Пары для кириллицы:**
| Латинская | Кириллица | Пример смешения |
|-----------|------------|----------------|
| a | а | `shlа` вместо `shla` |
| e | е | `cаrrefour` вместо `carrefour` |
| o | о | `Lidl` → `Lidо` |
| p | р | `kореrа` вместо `kopera` |
| c | с | `сarrefour` вместо `carrefour` |
| x | х | `2 х Brot` вместо `2 x Brot` |
| i | і | `shli` вместо `shлі` |

**Локали риска:** uk_UA, bg_BG, ru_RU, any bilingual чеки

### 10. Number Format (NUM_FMT)

Ошибки в распознавании чисел.

**Подтипы:**
- Разделитель: `6.99` вместо `6,99` (или наоборот)
- Потеря разделителя: `699` вместо `6,99`
- Лишний разделитель: `6,,99` или `6.99.99`
- Дублирование: `66,99` вместо `6,99`

---

## Частотность

Каждый артефакт должен быть помечен по частоте:

| Частота | Код | Критерий |
|--------|-----|----------|
| Редкий | `rare` | < 5% случаев |
| Редкий/случайный | `occasional` | 5-20% случаев |
| Частый | `frequent` | > 20% случаев |

---

## Правила исправления (fix_rule)

Формат правила для каждого артефакта:

```regex
# Обратная нотация для regex (что на что заменить)
pattern: "^0(?=[a-zäöü])"     # Что ищем
replacement: "O"               # На что заменяем
confidence: 0.95                # Уверенность (0.0-1.0)
context: "at word start before lowercase"  # Контекст применения
```

---

## Пример полного описания артефакта

```json
{
  "type": "CHAR_SUB",
  "subtype": "O/0 at word start",
  "ocr_text": "0livenöle",
  "expected_text": "Olivenöl",
  "locale": "de_DE",
  "frequency": "rare",
  "confidence": 0.90,
  "fix_rule": {
    "pattern": "^0(?=[a-zäöü])",
    "replacement": "O",
    "context": "Word start before lowercase letter",
    "applies_to": ["de_DE", "pl_PL", "cs_CZ"]
  },
  "examples": [
    "0livenöle → Olivenöl",
    "0bst → Obst",
    "0ffene → Offene"
  ],
  "occurrence_rate": 0.034
}
```

---

## Связанные документы

- [README.md](README.md) - методология сбора
- [MATRIX.md](MATRIX.md) - агрегированная матрица артефактов
- [by_locale/](by_locale/) - детальные артефакты по локалям
