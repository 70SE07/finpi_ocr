# Исследование: DTO товарной позиции - ФИНАЛЬНАЯ ВЕРСИЯ

## Цель

Определить минимальный и достаточный набор полей товарной позиции для передачи в Домен 3 (категоризация).

**Принцип:** Системное решение на уровне проекта. DTO работает для 100+ локалей и 10000+ вариаций чеков.

## Статус: ЗАВЕРШЕНО

| Метрика | Значение |
|---------|----------|
| Локали | 10 |
| Магазины | 27 |
| Чеки | 36+ |

---

## Сводная матрица полей (все локали)

| Поле | de_DE | pl_PL | es_ES | bg_BG | cs_CZ | tr_TR | en_IN | th_TH | pt_PT | uk_UA | % |
|------|-------|-------|-------|-------|-------|-------|-------|-------|-------|-------|---|
| raw_name | + | + | + | + | + | + | + | + | + | + | **100%** |
| total_price | + | + | + | + | + | + | + | + | + | + | **100%** |
| quantity | + | + | + | - | + | - | + | + | +/- | + | **80%** |
| unit_price | + | + | +/- | - | + | - | + | +/- | +/- | + | **70%** |
| tax_class | + | + | +/- | + | + | +/- | +/- | - | + | + | **75%** |
| is_discount | + | + | - | + | - | - | - | + | + | + | **60%** |
| sku | +/- | + | - | - | - | - | + | - | - | - | **25%** |
| unit | + | - | +/- | - | + | - | - | - | - | + | **40%** |
| category | HIT | - | - | - | - | - | - | - | pt_PT | - | **15%** |

---

## Детализация по магазинам Германии (13 магазинов)

| Поле | Lidl | ALDI | Netto | Penny | EDEKA | HIT | dm | Shell | CenterShop | Пекарни |
|------|------|------|-------|-------|-------|-----|-----|-------|------------|---------|
| sku | - | + | - | - | - | (код) | - | + | + (EAN) | #код |
| qty | + | + | + | - | +/- | +/- | - | - | - | + |
| unit | + | + | + | - | - | - | - | - | - | + |
| unit_price | + | + | + | - | +/- | +/- | - | - | - | + |
| tax_class | A/B | A/B | A/B | A/B | A/B/+/AW | A/B/F | 1/§1 | +A/+B | 19% | C/7% |

---

## ФИНАЛЬНЫЙ DTO

```python
from dataclasses import dataclass
from typing import Optional

@dataclass
class ParsedReceiptItem:
    """
    DTO товарной позиции для передачи в Домен 3 (категоризация).
    
    Протестирован на:
    - 10 локалях
    - 27 магазинах
    - 36+ чеках
    """
    
    # ═══════════════════════════════════════════════════════════════
    # ОБЯЗАТЕЛЬНЫЕ ПОЛЯ (100% присутствие во всех локалях)
    # ═══════════════════════════════════════════════════════════════
    
    raw_name: str
    """
    Название товара как на чеке (без нормализации).
    
    Примеры:
    - "Schweinenackenbraten" (de_DE)
    - "A_TORBA RECYKLING" (pl_PL) - с префиксом!
    - "ผัดมักกะโรนีไก่" (th_TH) - тайский
    - "ЯЙЦА L10 АКВИЛОН" (bg_BG) - кириллица
    """
    
    total_price: float
    """
    Итоговая сумма по позиции.
    
    Примечания:
    - Отрицательная для скидок/возвратов
    - Всегда в валюте чека
    - Может быть целым (uk_UA: 4248)
    """
    
    # ═══════════════════════════════════════════════════════════════
    # ВАЖНЫЕ ПОЛЯ (70-80% присутствие)
    # ═══════════════════════════════════════════════════════════════
    
    quantity: Optional[float] = None
    """
    Количество товара.
    
    Форматы:
    - Целое: 1, 2, 3
    - Дробное (весовые): 1.207, 0.834
    - None если не указано (implicit 1)
    """
    
    unit_price: Optional[float] = None
    """
    Цена за единицу.
    
    Примечания:
    - Для весовых: EUR/kg, PLN/kg
    - None если qty=1 и не указана
    """
    
    is_discount: bool = False
    """
    Флаг скидки/возврата/акции.
    
    Ключевые слова по локалям:
    - de_DE: Preisvorteil, Rabatt, Nachlass
    - pl_PL: Anulowano sprzedaż
    - bg_BG: ОТСТ., ОТСТЪПКА
    - th_TH: ส่วนลด
    - uk_UA: Знижка
    """
    
    tax_class: Optional[str] = None
    """
    Налоговый класс как на чеке.
    
    ВАЖНО: НЕ нормализовать! Передавать как есть:
    - "A", "B", "C" (буквы)
    - "1", "§1" (числа)
    - "+A", "+B" (с плюсом)
    - "*Б" (со звездочкой)
    - "Я" (кириллица)
    """
    
    # ═══════════════════════════════════════════════════════════════
    # ОПЦИОНАЛЬНЫЕ ПОЛЯ (зависит от магазина)
    # ═══════════════════════════════════════════════════════════════
    
    sku: Optional[str] = None
    """
    Артикул/код товара.
    
    Форматы:
    - 6 цифр: "826945" (ALDI)
    - EAN-13: "4047834300063" (CenterShop)
    - #код: "#414" (пекарни)
    - (код): "(399)" (HIT)
    """
    
    unit: Optional[str] = None
    """
    Единица измерения.
    
    Примеры:
    - "kg", "g", "l", "ml"
    - "Stück", "Pár", "шт", "szt"
    """
    
    category: Optional[str] = None
    """
    Категория товара (если есть на чеке).
    
    Только для:
    - HIT (de_DE): LEBENSMITTEL, GETRÄNKE, NON FOOD...
    - Continente (pt_PT): Frutas e Legumes
    """
    
    # ═══════════════════════════════════════════════════════════════
    # СЛУЖЕБНЫЕ ПОЛЯ (для отладки и валидации)
    # ═══════════════════════════════════════════════════════════════
    
    raw_line: Optional[str] = None
    """Исходная строка(и) с чека для отладки."""
    
    line_number: Optional[int] = None
    """Номер строки на чеке."""
    
    confidence: float = 1.0
    """
    Уверенность парсинга (0.0-1.0).
    
    Снижается при:
    - Нечитаемых символах
    - Неполных данных
    - Эвристических решениях
    """


# ═══════════════════════════════════════════════════════════════════
# ДОПОЛНИТЕЛЬНЫЕ ПОЛЯ (специфичные для локалей)
# ═══════════════════════════════════════════════════════════════════

@dataclass
class ParsedReceiptItemExtended(ParsedReceiptItem):
    """
    Расширенный DTO с полями для специфичных локалей.
    Использовать только если нужны дополнительные данные.
    """
    
    discount_percent: Optional[float] = None
    """Процент скидки (только ALDI): 30.0"""
    
    is_pfand: bool = False
    """Флаг залога за тару (de_DE)."""
    
    is_fresh: bool = False
    """Флаг товара с прилавка (HIT: F маркер)."""
    
    timestamp: Optional[str] = None
    """Время добавления товара (Kleins Backstube)."""
    
    tax_rate: Optional[float] = None
    """Ставка налога в процентах (tr_TR: %10)."""
```

---

## Ответы на открытые вопросы

### 1. Нужен ли Домену 3 tax_class?

**Ответ:** ОПЦИОНАЛЬНО.
- Для парсинга: ДА (checksum по классам)
- Для категоризации: НЕТ (не влияет на категорию товара)
- **Решение:** Передаем, но не обязательное поле

### 2. Как обрабатывать скидки?

**Ответ:** `is_discount: bool = True`, `total_price` отрицательный.

Ключевые слова скидок:
- DE: Preisvorteil, Rabatt, Nachlass, *** Discount Preis ***
- PL: Anulowano sprzedaż
- BG: ОТСТ., ОТСТЪПКА
- TH: ส่วนลด
- UA: Знижка
- PT: POUPANCA

### 3. Unit стандартизация?

**Ответ:** НЕ нормализовать в OCR+Parsing.
- Оставляем как на чеке: "kg", "Stück", "шт", "szt"
- Нормализация - задача Домена 3
- DRY principle: один источник правды

### 4. Что делать с префиксами (A_, C_)?

**Ответ:** Включать в raw_name.
- `raw_name: "A_TORBA RECYKLING"` - полное название
- Домен 3 может извлечь tax class из префикса если нужно

---

## Примеры использования

```python
# Простой товар (dm)
item1 = ParsedReceiptItem(
    raw_name="babylove Windeln Newb.XS 24St",
    total_price=2.95,
    tax_class="1"
)

# Весовой товар (Lidl)
item2 = ParsedReceiptItem(
    raw_name="Schweinenackenbraten",
    total_price=10.85,
    quantity=1.207,
    unit="kg",
    unit_price=8.99,
    tax_class="A"
)

# Скидка (ALDI)
item3 = ParsedReceiptItem(
    raw_name="F&G Häh Min.schn",
    total_price=-1.65,
    is_discount=True,
    tax_class="A"
)

# Товар с категорией (HIT)
item4 = ParsedReceiptItem(
    raw_name="Lammkarree fr.",
    total_price=6.01,
    sku="(399)",
    tax_class="B",
    category="Bedientheke"
)
```
