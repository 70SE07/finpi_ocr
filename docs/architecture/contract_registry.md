# Реестр Контрактов (Contract Registry)

Данный документ фиксирует нерушимые договоренности между модулями (элементами) пайплайна. Каждый элемент обязан поставлять результат, соответствующий своему Контракту.

## Философия
Каждый контракт описывает **ЦКП (Центральный Конечный Продукт)** модуля.

---

## 1. Phase: Pre-OCR (Подготовка изображения)

### Stage: Pre-OCR (Pipeline Stage)
*   **Input:** Сырое изображение чека (любой формат, размер, цветовая модель).
*   **Output (Product):** Эталонный цифровой слепок текста, очищенный от физических шумов носителя.
*   **Specification (Guarantee):** Файл `.jpg` в папке `pre_ocr/`, монохромный (1 канал), максимальный размер по длинной стороне — 2200px.

#### Element: ImageCompressor (Модуль)
*   **Input:** `numpy.ndarray` (RGB) или путь к файлу.
*   **Output (Product):** Оптимизированный по весу и размеру визуальный актив, пригодный для скоростной передачи в облако без потери читаемости.
*   **Specification (Guarantee):** 
    - Максимальное разрешение: 2200px (по любой стороне).
    - Сохранение Aspect Ratio (пропорций).
    - Формат: RGB (3 канала).
    - Качество: JPEG 85% (баланс артефактов и веса).

#### Element: Grayscale / BlueChannel (Модуль)
*   **Input:** Оптимизированный RGB `numpy.ndarray` (результат Compressor).
*   **Output (Product):** Контрастная монохромная карта текста («цифровой негатив»), где буквы максимально отделены от фона.
*   **Specification (Guarantee):**
    - Формат: Grayscale (1 канал).
    - Метод: Извлечение Blue-канала (для подавления просвечивающего текста и цветных пятен).
    - Отсутствие изменения разрешения (размер на входе = размер на выходе).

---

## 2. Phase: OCR (Распознавание)

### Stage: OCR (Google Vision)
*   **Input:** Преобработанное изображение (1 канал, <2200px).
*   **Output (Product):** "Сырой" JSON-отклик от Google Cloud Vision API.
*   **Specification (Guarantee):** Полная копия структуры данных `google.cloud.vision.AnnotateImageResponse`.

---

## 3. Phase: Post-OCR (Обработка данных)

### Stage: Layout (Структура)
*   **Input:** Список слов с координатами из OCR.
*   **Output (Product):** Восстановленное текстовое полотно (Text Map), где слова объединены в строки по горизонтали и отсортированы сверху вниз.
*   **Specification (Guarantee):** Список объектов `Line`, где каждый содержит склеенный текст и bounding box строки.

### Stage: Metadata (Метаданные)
*   **Input:** Список строк (Layout).
*   **Output (Product):** Паспорт транзакции — расширенный набор фактов о покупке (Магазин, Дата, Сумма, Адрес, Реквизиты).
*   **Specification (Guarantee):** Объект `MetadataResult`. Поля: `store_name`, `brand`, `date`, `total_amount`, `address`, `phone`, `vat_id`. Все поля `Optional`, но ключи обязательны.

#### Element: AddressExtractor
*   **Input:** `List[str]` — очищенные текстовые строки чека.
*   **Output (Product):** Географическая привязка точки продажи (чистый адрес без телефонов).
*   **Specification (Guarantee):** 
    - Поиск по ZIP-кодам (DE, UA, PL, PT) + ключевым словам улиц.
    - Объединение до 3-х строк при обнаружении частичного совпадения.
    - Адрес очищается от телефонных номеров перед возвратом (телефоны извлекаются отдельно через RequisitesExtractor).

#### Element: RequisitesExtractor
*   **Input:** `List[str]` — очищенные текстовые строки чека.
*   **Output (Product):** Юридические и контактные идентификаторы (Phone, VAT ID).
*   **Specification (Guarantee):** 
    - Извлечение телефонов (международные и локальные форматы).
    - Извлечение налоговых идентификаторов (UID, VAT, ИНН) по маскам стран.

### Stage: Semantic (Семантика товаров)
*   **Input:** Текстовые строки (Layout) + Метаданные.
*   **Output (Product):** Массив товарных позиций (Line Items) — четкий список покупок (имя, количество, цена).
*   **Specification (Guarantee):** Список объектов `ReceiptItem` (DTO).
