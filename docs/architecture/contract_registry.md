# Реестр Контрактов (Contract Registry)

Данный документ фиксирует нерушимые договоренности между операциями пайплайна. Каждая операция обязана поставлять результат, соответствующий своему Контракту.

## Философия

**Stage = SRP = ЦКП.** Каждый контракт описывает ЦКП (Ценный Конечный Продукт) операции.

Подробнее: [PROJECT_VISION.md](../PROJECT_VISION.md#философия-stages-в-пайплайне) | Термины: [GLOSSARY.md](../GLOSSARY.md)

---

## 1. Phase: Pre-OCR (Подготовка изображения)

### Stage: Pre-OCR Pipeline

*   **Input:** Сырое изображение чека (любой формат, размер, цветовая модель).
*   **Output (ЦКП):** Эталонный цифровой слепок текста, очищенный от физических шумов носителя.
*   **Specification (Guarantee):** Монохромное изображение (1 канал), оптимизированное для OCR.

#### Логика последовательности Operations

```
[Сырое фото 4032x2268 RGB, 3MB]
         ↓
    Operation: ImageCompressor
    Проблема: Размер/вес (дорого передавать в облако)
         ↓
[RGB 1237x2200, 650KB]
         ↓
    Operation: Grayscale
    Проблема: Цветной шум (bleed-through, цветные пятна)
         ↓
[Grayscale 1237x2200, 1 канал]
         ↓
    → Stage: OCR
```

**Почему такой порядок:**
1. **Сначала Compress** — уменьшаем данные для всех последующих операций (быстрее)
2. **Потом Grayscale** — работаем с уже уменьшенным изображением (экономия ресурсов)

---

#### Operation: ImageCompressor

| Аспект | Значение |
|--------|----------|
| **Проблема** | Изображение слишком большое для передачи в облако |
| **SRP** | Оптимизация размера и веса |
| **ЦКП** | Оптимизированный визуальный актив, пригодный для скоростной передачи без потери читаемости |

*   **Input:** `numpy.ndarray` (RGB) или путь к файлу.
*   **Output:** Сжатое RGB изображение.
*   **Config:** 
    - `MAX_IMAGE_SIZE` (default: 2200px) — максимальное разрешение.
    - `JPEG_QUALITY` (default: 85%) — качество сжатия.
*   **Specification (Guarantee):** 
    - Сохранение Aspect Ratio (пропорций).
    - Формат: RGB (3 канала).

---

#### Operation: Grayscale

| Аспект | Значение |
|--------|----------|
| **Проблема** | Цветной шум мешает OCR (bleed-through, цветные пятна, реклама) |
| **SRP** | Удаление цветовой информации с сохранением контраста текста |
| **ЦКП** | Контрастная монохромная карта текста, где буквы максимально отделены от фона |

*   **Input:** Оптимизированный RGB `numpy.ndarray` (результат ImageCompressor).
*   **Output:** Grayscale изображение (1 канал).
*   **Config:** `GRAYSCALE_METHOD` (default: "blue_channel").
*   **Specification (Guarantee):** Размер на входе = размер на выходе.

**Методы конвертации (GRAYSCALE_METHOD):**

| Метод | Описание | Когда использовать |
|-------|----------|-------------------|
| `blue_channel` | Извлечение синего канала | Лучше для bleed-through (просвечивание) |
| `luminosity` | Взвешенное среднее (0.299R + 0.587G + 0.114B) | Стандартный метод |
| `average` | Простое среднее каналов | Базовый метод |

---

## 2. Phase: OCR (Распознавание)

### Stage: OCR (Google Vision)
*   **Input:** Преобработанное изображение (1 канал, <2200px).
*   **Output (Product):** "Сырой" JSON-отклик от Google Cloud Vision API.
*   **Specification (Guarantee):** Полная копия структуры данных `google.cloud.vision.AnnotateImageResponse`.

---

## 3. Phase: Post-OCR (Обработка данных)

### Stage: Layout (Структура)
*   **Input:** Список слов с координатами из OCR.
*   **Output (Product):** Восстановленное текстовое полотно (Text Map), где слова объединены в строки по горизонтали и отсортированы сверху вниз.
*   **Specification (Guarantee):** Список объектов `Line`, где каждый содержит склеенный текст и bounding box строки.

### Stage: Metadata (Метаданные)
*   **Input:** Список строк (Layout).
*   **Output (Product):** Паспорт транзакции — расширенный набор фактов о покупке (Магазин, Дата, Сумма, Адрес, Реквизиты).
*   **Specification (Guarantee):** Объект `MetadataResult`. Поля: `store_name`, `brand`, `date`, `total_amount`, `address`, `phone`, `vat_id`. Все поля `Optional`, но ключи обязательны.

#### Operation: AddressExtractor
*   **Input:** `List[str]` — очищенные текстовые строки чека.
*   **Output (Product):** Географическая привязка точки продажи (чистый адрес без телефонов).
*   **Specification (Guarantee):** 
    - Поиск по ZIP-кодам (DE, UA, PL, PT) + ключевым словам улиц.
    - Объединение до 3-х строк при обнаружении частичного совпадения.
    - Адрес очищается от телефонных номеров перед возвратом (телефоны извлекаются отдельно через RequisitesExtractor).

#### Operation: RequisitesExtractor
*   **Input:** `List[str]` — очищенные текстовые строки чека.
*   **Output (Product):** Юридические и контактные идентификаторы (Phone, VAT ID).
*   **Specification (Guarantee):** 
    - Извлечение телефонов (международные и локальные форматы).
    - Извлечение налоговых идентификаторов (UID, VAT, ИНН) по маскам стран.

### Stage: Semantic (Семантика товаров)
*   **Input:** Текстовые строки (Layout) + Метаданные.
*   **Output (Product):** Массив товарных позиций (Line Items) — четкий список покупок (имя, количество, цена).
*   **Specification (Guarantee):** Список объектов `ReceiptItem` (DTO).
