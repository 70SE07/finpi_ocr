# ADR-009: Гарантии качества D2 (Parsing)

**Статус:** Утверждено  
**Дата:** 2025-12-30  
**Вопросы плана:** Q2.3, Q2.4

---

## Контекст

D2 (Parsing) - ключевой домен, отвечающий за преобразование сырых данных OCR в структурированные данные чека.

Вопрос: какие гарантии дает D2? Как обрабатываются "проблемные" чеки?

---

## Решение

### Ключевой принцип

> **Система ГАРАНТИРУЕТ 100% результат для КАЖДОГО чека.**

### Принципы качества D2

| Принцип | Описание |
|---------|----------|
| **100% success rate** | Каждый чек ДОЛЖЕН быть обработан. Нет исключений. |
| **Нет "невалидных чеков"** | "Невалидный чек" = БАГ СИСТЕМЫ, не проблема чека |
| **Нет "отклоненных чеков"** | Такого понятия не существует |
| **Checksum обязателен** | Если checksum не сошелся = нужно чинить D2 |
| **D2 = гарант качества** | В D3 уходит ТОЛЬКО 100% валидный результат |

---

## Что это значит на практике

### Если чек не парсится:

```
НЕ ПРАВИЛЬНО:
  Чек → D2 → "Ошибка: невозможно распарсить" → чек отклонен

ПРАВИЛЬНО:
  Чек → D2 → "Ошибка" → анализ → исправление D2 → чек обработан
```

### Если checksum не сходится:

```
НЕ ПРАВИЛЬНО:
  SUM(items) ≠ total → передать с флагом "mismatch" → D3 разберется

ПРАВИЛЬНО:
  SUM(items) ≠ total → БАГ в D2 → исправить логику → checksum сойдется
```

---

## Сигналы качества в D3

**Вопрос Q2.3:** Нужны ли D3 сигналы качества?

**Ответ:** НЕТ.

| Сигнал | Передавать в D3? | Причина |
|--------|------------------|---------|
| `checksum_status` | НЕТ | D2 гарантирует. Если выдал - значит валидно. |
| `parsing_confidence` | НЕТ | D2 гарантирует 100%. Нет "частичного" качества. |
| `warnings` | НЕТ | Проблемы решаются в D2, не передаются дальше. |

**В D3 передается ТОЛЬКО ЦКП:**
- `items` (чистые, валидированные)
- `total_amount` (проверенный)
- `merchant`, `date`, `locale` (метаданные)

---

## Граница ответственности

**Вопрос Q2.4:** Кто отвечает за качество?

**Ответ:** D2 отвечает на 100%.

| Аспект | Ответственность |
|--------|-----------------|
| Парсинг всех чеков | D2 |
| Валидация checksum | D2 |
| Качество данных | D2 |
| "Невозможные" чеки | D2 (нужно доработать систему) |

D3 **доверяет** D2 и не перепроверяет данные.

---

## Как достигается 100% success rate

1. **Паттерны** - документируем ВСЕ форматы чеков
2. **Локали** - поддерживаем ВСЕ страны и магазины
3. **Ground Truth** - тестируем на реальных чеках
4. **Итеративное улучшение** - каждый "проблемный" чек = улучшение системы

---

## Связанные документы

- ADR-002: ЦКП доменов
- ADR-004: Контракты DTO
- contracts/d2_parsing_dto.py

---

## История изменений

| Дата | Изменение |
|------|-----------|
| 2025-12-30 | Создан документ. Утверждены принципы качества D2. |
