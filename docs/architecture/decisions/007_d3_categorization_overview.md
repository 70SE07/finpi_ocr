# ADR-007: Понимание D3 (Categorization) - Внешний домен

**Статус:** Информационный  
**Тип:** Внешняя зависимость (не наша зона ответственности)

---

## Контекст

D3 (Categorization) - это внешний домен, который:
- Уже реализован в `finpi_parser_photo`
- Имеет стабильный контракт (`RawReceiptDTO` на входе, `ParseResultDTO` на выходе)
- НЕ является нашей зоной ответственности

Мы (D1 + D2) должны понимать КАК работает D3 на уровне архитектуры, чтобы:
- Передавать данные в правильном формате
- Понимать что критично для качества категоризации
- Не дублировать логику

---

## Ключевое понимание

### Задача D2 для D3

> **Передать `name` товара ТОЧНО как на чеке, без потерь и искажений.**

D3 сделает остальное через свою архитектуру (Constitution + Directories + LLM).

---

## Архитектура D3 (высокоуровнево)

### Три столпа категоризации

| Компонент | Файл | Роль |
|-----------|------|------|
| **Constitution** | `constitution/constitution.json` | 14 принципов КАК категоризировать |
| **Directories** | `directories/directories.json` | Справочник КАКИХ категорий существует (L1-L5) |
| **Accelerators** | `accelerators/{locale}.json` | Кэш готовых ответов (по локалям) |

### Пайплайн категоризации

```
INPUT: name + locale
       │
       ▼
┌─────────────────┐
│   ACCELERATOR   │──▶ HIT? ──▶ Готово (0 токенов, 0ms)
│   (кэш)         │
└────────┬────────┘
         │ MISS
         ▼
┌─────────────────┐
│ SEMANTIC SEARCH │──▶ Поиск похожих примеров из Constitution
└────────┬────────┘
         ▼
┌─────────────────┐
│ LLM (3 вызова): │
│  1. L1+L2       │──▶ (GOODS/SERVICE + категория)
│  2. L3          │──▶ (подкатегория)
│  3. L4+L5       │──▶ (тип + характеристики)
└────────┬────────┘
         ▼
┌─────────────────┐
│ VALIDATION      │──▶ Проверка по Constitution + Directories
└────────┬────────┘
         ▼
      RESULT: L1-L5 категории
```

**Примечание:** Текущая реализация D3 использует LLM (Large Language Model) для категоризации. Конкретная модель (GPT, Gemini, DeepSeek и др.) может меняться - это деталь реализации D3.

### 5-уровневая иерархия категорий

| Уровень | Название | Пример | Обязателен |
|---------|----------|--------|------------|
| L1 | Product Type | GOODS, SERVICE | Да |
| L2 | Category | GROCERIES, HOUSEHOLD_GOODS | Да |
| L3 | Subcategory | DAIRY, VEGETABLES, CHEESE | Да |
| L4 | Type | MILK, EMMENTAL, TOMATOES | Нет |
| L5 | Characteristics | ["UHT", "3.5_PERCENT_FAT"] | Нет (только если L4 есть) |

### Ключевые принципы Constitution

| Принцип | Суть | Пример нарушения |
|---------|------|------------------|
| **Atomicity** | Категории атомарны | DAIRY_AND_CHEESE - запрещено |
| **Hierarchical Dependency** | L5 только если L4 заполнен | L4=null, L5=["ORGANIC"] - запрещено |
| **Essence vs Characteristic** | L4 = сущность, L5 = свойства | "Frozen" в L4 - неверно, должно быть в L5 |

---

## Что важно для D2

### D3 сам понимает языки

- LLM обучены на текстах всех языков мира
- "Milch", "Молоко", "Milk" - LLM знает что это молоко
- Понимание языка - задача D3, не D2

### D3 работает с сокращениями

Примеры реальных названий с чеков:
- `PMTO PIQUI.CONSUM` - Pimiento Piquillo Consum
- `BAT.00% PROTE.CACAO` - Батончик 0% протеиновый какао
- `S.JAMON CEBO IB.` - Снеки хамон Cebo Iberico

LLM понимает такие сокращения. Расшифровка сокращений - задача D3, не D2.

### Что D2 должен передать

```python
RawReceiptItem:
    name: str       # КРИТИЧНО: точно как на чеке
    quantity: float | None
    price: float | None
    total: float | None
    date: datetime | None
```

**`name` - это единственное что влияет на категоризацию.**

Остальные поля (quantity, price, total) - для финансовой аналитики, не для категоризации.

---

## Граница ответственности

| Аспект | D2 (Parsing) | D3 (Categorization) |
|--------|--------------|---------------------|
| Извлечение `name` | ДА | нет |
| Понимание языка | нет | ДА (LLM) |
| Перевод | нет | нет (не нужен) |
| Определение L1-L5 | нет | ДА |
| Валидация категорий | нет | ДА |
| Качество `name` | ДА | зависит от D2 |

---

## Что НЕ делать в D2

### 1. НЕ переводить `name`:

- С немецкого на английский ("Milch" не переводить на "Milk")
- С русского на английский ("Молоко" не переводить на "Milk")
- С любого языка на любой другой

**Причина:** LLM понимает все языки. Перевод может исказить смысл или потерять нюансы оригинала.

### 2. НЕ создавать словари локальных сокращений

**Причина:** Это бесконечная работа. LLM справляется с сокращениями сам.

### 3. НЕ пытаться категоризировать

**Причина:** Это задача D3 с его Constitution + Directories + LLM.

### 4. НЕ менять структуру `RawReceiptDTO`

**Причина:** Это жесткий контракт, D3 зависит от него.

---

## Правила очистки `name` (РЕШЕНО)

**Статус:** УТВЕРЖДЕНО (см. ADR-008)

| Тип данных | Решение |
|------------|---------|
| SKU / Коды товаров | УБИРАТЬ |
| Налоговые классы (A, B) | УБИРАТЬ |
| Сокращения магазина (MC, JZN, F&G) | ОСТАВЛЯТЬ |
| Вес/размер (400g, 3.5%) | ОСТАВЛЯТЬ |
| Категории магазина (HIT) | НЕ ПЕРЕДАВАТЬ в D3 |

Подробнее: [ADR-008: Правила очистки name](008_d2_name_cleaning_rules.md)

---

## Источники информации о D3

| Документ | Путь | Содержание |
|----------|------|------------|
| Архитектура AI | `finpi_parser_photo/docs/AI_CATEGORIZATION_ARCHITECTURE.md` | Решения и тесты |
| Система | `finpi_parser_photo/docs/categorization/SYSTEM.md` | Пайплайн |
| README | `finpi_parser_photo/infrastructure/ai_categorizer/README.md` | Deep dive |
| Constitution | `finpi_parser_photo/infrastructure/ai_categorizer/constitution/` | Принципы |
| Directories | `finpi_parser_photo/infrastructure/ai_categorizer/directories/` | Категории |

---

## Резюме

1. **D3 - не наша зона ответственности**, но мы понимаем архитектуру
2. **Задача D2**: передать `name` с минимальной очисткой (см. ADR-008)
3. **D3 сам**: понимает языки и сокращения через LLM, категоризирует по Constitution + Directories
4. **Контракт D2 к D3**: `RawReceiptDTO` (верифицирован 1 в 1)
5. **D2 убирает**: SKU, налоговые классы. **D2 оставляет**: сокращения магазина, вес/размер (см. ADR-008)
6. **D2 не переводит** и **не категоризирует** - это задачи D3
