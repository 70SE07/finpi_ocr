# ADR-014: Обработка Edge Cases

## Статус
**Утверждено** (31.12.2024)

## Контекст

При парсинге чеков из 100+ локалей и тысяч магазинов возникают сложные случаи:
- 2-колоночные чеки
- Скидки и акции
- Залоговая тара (Pfand)
- Многострочные названия товаров

Нужны системные решения, применимые ко всем локалям.

## Фундаментальный принцип

> **Парсим 1 в 1 как на бумажном чеке**

Если на чеке скидка — отдельная строка, в DTO она — отдельный item.
Если на чеке Pfand — отдельная строка, в DTO она — отдельный item.

Это гарантирует:
1. Checksum сходится автоматически
2. Прозрачность для пользователя
3. Простота парсинга (не нужно "склеивать" строки)

---

## Q6.1: 2-колоночные чеки

### Проблема
Некоторые чеки (Mercadona, Aldi) печатают товары в 2 колонки для экономии бумаги.

### Решение: Layout-анализ по X-координате

```
Колонка 1 (X < 50%)     |    Колонка 2 (X > 50%)
------------------------|------------------------
Молоко          1.20    |    Хлеб           0.80
Сыр             2.50    |    Масло          1.50
```

**Алгоритм:**
1. D1 передаёт `words[]` с `bounding_box.x`
2. D2 определяет границу колонок (обычно ~50% ширины)
3. Слова группируются по колонкам
4. Каждая колонка парсится как обычный чек
5. Items объединяются в единый список

**Конфигурация (store config):**
```yaml
layout:
  type: two_column
  column_boundary: 0.5  # 50% ширины
```

---

## Q6.2: Скидки

### Проблема
Скидки на чеках представлены по-разному:
- `Preisvorteil -0.50`
- `RABATT 20% -0.44`
- `Aktionsnachlass -0.47`

### Решение: Отдельный item с отрицательной ценой

**На чеке:**
```
Edamer Scheiben         2,49 A
Preisvorteil           -0,04 A
```

**В DTO:**
```json
{"raw_name": "Edamer Scheiben", "total_price": 2.49, "tax_class": "A"},
{"raw_name": "Preisvorteil", "total_price": -0.04, "tax_class": "A", "is_discount": true}
```

**Почему так:**
1. **1 в 1 как на чеке** — скидка это отдельная строка
2. **Checksum сходится** — сумма товаров включает отрицательные скидки
3. **Прозрачность** — пользователь видит структуру как на чеке

**Паттерны скидок (конфиг локали):**
```yaml
discount_patterns:
  - "Preisvorteil"
  - "RABATT"
  - "Aktionsnachlass"
  - "Rabattaktion"
  - "Aktionsrabatt"
  - "Descuento"
  - "DTO"
```

---

## Q6.3: Pfand (залоговая тара)

### Проблема
В Германии напитки продаются с залогом за тару (Pfand).
При возврате тары — отрицательный Pfand (Pfandrückgabe).

### Решение: Отдельный item с флагом `is_pfand`

**На чеке (покупка):**
```
Mineralwasser 6x1.5L    2,34 B
Pfand                   1,50 M
```

**В DTO:**
```json
{"raw_name": "Mineralwasser 6x1.5L", "total_price": 2.34, "tax_class": "B"},
{"raw_name": "Pfand", "total_price": 1.50, "tax_class": "M", "is_pfand": true}
```

**На чеке (возврат):**
```
Pfandrückgabe          -23,00 B
```

**В DTO:**
```json
{"raw_name": "Pfandrückgabe", "qty": 92, "total_price": -23.00, "tax_class": "B", "is_pfand": true}
```

**Почему так:**
1. **1 в 1 как на чеке** — Pfand это отдельная строка
2. **Tax class M** — 0% НДС (особый класс для залога)
3. **Pfandrückgabe** — возврат с отрицательной суммой

**Паттерны Pfand (конфиг локали de_DE):**
```yaml
pfand_patterns:
  - "Pfand"
  - "Pfand 0,25"
  - "Pfand 6,00"
  - "Pfandrückgabe"
  - "Leergut"
```

---

## Q6.4: Многострочные названия товаров

### Проблема
Длинные названия товаров переносятся на следующую строку:
```
Горбуша натуральная
  ключи 245г            2.89 A
```

### Решение: Объединение строк по Y-координате

**Алгоритм:**
1. D1 передаёт `words[]` с `bounding_box.y`
2. D2 группирует слова по Y-координате (threshold ~10-15px)
3. Строки без цены в конце = продолжение предыдущей
4. Объединяем в один `raw_name`

**Логика определения "продолжения":**
```python
def is_continuation(line: str, next_line: str) -> bool:
    # Строка без цены в конце
    has_price = re.search(r'\d+[.,]\d{2}\s*[A-Z]?\s*$', line)
    return not has_price
```

**Результат:**
```json
{"raw_name": "Горбуша натуральная ключи 245г", "total_price": 2.89, "tax_class": "A"}
```

---

## Сводная таблица

| Edge Case | Решение | Принцип | Конфигурация |
|-----------|---------|---------|--------------|
| 2-колоночные | Layout по X-координате | Системный анализ | `store_config.layout.type` |
| Скидки | Отдельный item, `-price` | 1 в 1 как на чеке | `locale_config.discount_patterns` |
| Pfand | Отдельный item, `is_pfand` | 1 в 1 как на чеке | `locale_config.pfand_patterns` |
| Многострочные | Объединение по Y | Layout-анализ | Threshold в коде |

## Известные ограничения

> **ВАЖНО:** Текущая система (D3 + Orchestrator) НЕ принимает отрицательные значения.
> - `RawReceiptDTO`: `if v < 0: raise ValueError`
> - `TransactionsRequest`: `price: Decimal = Field(..., ge=0)`
>
> При интеграции D2→D3 потребуется либо изменить валидацию в D3/Orchestrator,
> либо использовать альтернативный подход (например, `type_operation: INCOME`).
>
> Это не блокер для D2 — решение принято концептуально верным ("1 в 1 как на чеке").

## Связанные решения

- [ADR-006: D1->D2 Contract Design](006_d1_d2_contract_design.md) — передача `words[]` с координатами
- [ADR-010: Locale-Store Hierarchy](010_locale_store_hierarchy.md) — конфигурация паттернов
- [PROJECT_VISION.md](../../PROJECT_VISION.md) — 100% качество, 1 в 1 как на чеке
