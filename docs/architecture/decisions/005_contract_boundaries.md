# ADR-005: Границы контрактов между доменами

**Статус:** Принято  
**Вопрос плана:** Q2.0 (финализация)

---

## Контекст

Система состоит из 3 доменов и оркестратора:
- D1 (Extraction) - оцифровка чека (OCR)
- D2 (Parsing) - структурирование данных
- D3 (Categorization) - категоризация товаров
- Orchestrator - внешние сервисы (Telegram, Frontend)

Необходимо четко определить какие контракты жесткие (immutable), а какие гибкие.

---

## Решение

### Две зоны контрактов

```
┌─────────────────────────────────────────────────────────────────────┐
│                      ЗОНА СВОБОДЫ (Наша)                            │
│                                                                     │
│   D1 (Extraction)  ───────────→  D2 (Parsing)                       │
│                                                                     │
│   - Любая структура данных                                          │
│   - Любые имена полей (raw_name, name - без разницы)                │
│   - Оптимизируем для качества 100%                                  │
│   - МЫ АВТОРЫ = МЫ СОЗДАЕМ ПРАВИЛА                                  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                 ЖЕСТКИЕ КОНТРАКТЫ (1 в 1 с finpi_parser_photo)      │
│                                                                     │
│   D2 ──→ D3:           RawReceiptDTO                                │
│   D3 ──→ Orchestrator: ParseResultDTO                               │
│                                                                     │
│   - НЕЛЬЗЯ менять структуру                                         │
│   - НЕЛЬЗЯ менять имена полей                                       │
│   - НЕЛЬЗЯ менять типы данных                                       │
│   - Внешние сервисы ЗАВИСЯТ от этих контрактов                      │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Жесткие контракты (Immutable)

### D2 → D3: RawReceiptDTO

**Источник:** `finpi_parser_photo/domain/dto/raw_receipt_dto.py`  
**Копия:** `contracts/d2_parsing_dto.py`

#### RawReceiptItem

| Поле | Тип | Required | Описание |
|------|-----|----------|----------|
| `name` | `str` | да | Название товара как на чеке |
| `quantity` | `float \| None` | нет | Количество (>0) |
| `price` | `float \| None` | нет | Цена за единицу (>=0) |
| `total` | `float \| None` | нет | Итоговая цена (>=0) |
| `date` | `datetime \| None` | нет | Дата товара |

#### RawReceiptDTO

| Поле | Тип | Required | Описание |
|------|-----|----------|----------|
| `items` | `list[RawReceiptItem]` | да | Список товаров без категорий |
| `total_amount` | `float \| None` | нет | Итого по чеку |
| `merchant` | `str \| None` | нет | Название магазина |
| `store_address` | `str \| None` | нет | Адрес магазина |
| `date` | `datetime \| None` | нет | Дата чека |
| `receipt_id` | `str \| None` | нет | ID чека |
| `ocr_text` | `str \| None` | нет | Raw OCR текст (debug) |
| `detected_locale` | `str \| None` | нет | Локаль |
| `metrics` | `dict[str, float]` | да | Метрики парсинга |

---

### D3 → Orchestrator: ParseResultDTO

**Источник:** `finpi_parser_photo/domain/dto/parse_receipt_dto.py`  
**Копия:** `contracts/d3_categorization_dto.py`

#### ReceiptItem

| Поле | Тип | Required | Описание |
|------|-----|----------|----------|
| `name` | `str` | да | Название товара |
| `quantity` | `float \| None` | нет | Количество (>0) |
| `price` | `float \| None` | нет | Цена за единицу |
| `total` | `float \| None` | нет | Итоговая цена |
| `product_type` | `str` | да | L1: GOODS или SERVICE |
| `product_category` | `str` | да | L2: категория |
| `product_subcategory_l1` | `str` | да | L3: товарная группа |
| `product_subcategory_l2` | `str \| None` | нет | L4: тип продукта |
| `product_subcategory_l3` | `list[str] \| None` | нет | L5: характеристики |
| `needs_manual_review` | `bool \| None` | нет | Флаг ручной проверки (default: False) |
| `merchant` | `str \| None` | нет | Название магазина |
| `store_address` | `str \| None` | нет | Адрес магазина |
| `date` | `datetime \| None` | нет | Дата |

#### ReceiptSums

| Поле | Тип | Required | Описание |
|------|-----|----------|----------|
| `total` | `float \| None` | нет | Итоговая сумма |

#### DataValidityInfo

| Поле | Тип | Required | Описание |
|------|-----|----------|----------|
| `sum_validation_passed` | `bool` | да | Прошла ли проверка суммы |
| `sum_difference` | `float \| None` | нет | Разница (если есть) |

#### ParseResultDTO

| Поле | Тип | Required | Описание |
|------|-----|----------|----------|
| `success` | `bool` | да | Успешность парсинга |
| `items` | `list[ReceiptItem]` | да | Товары с категориями |
| `sums` | `ReceiptSums \| None` | нет | Суммы |
| `error` | `str \| None` | нет | Текст ошибки |
| `receipt_id` | `str \| None` | нет | ID чека |
| `data_validity` | `DataValidityInfo \| None` | нет | Информация о валидации |
| `total_amount` | `float \| None` | нет | (deprecated) |

---

## Гибкие контракты (Наша зона)

### D1 → D2

**Статус:** Определяется нами  
**Файл:** `contracts/d1_extraction_dto.py`

Мы авторы этого контракта и можем:
- Использовать любую структуру
- Называть поля как удобно
- Добавлять/удалять поля
- Оптимизировать для качества

Цель: обеспечить D2 всей необходимой информацией для достижения **100% качества** парсинга.

---

## Верификация

### Статус проверки (2025-12-29)

| Контракт | Источник | Статус |
|----------|----------|--------|
| D2 → D3 | `finpi_parser_photo/domain/dto/raw_receipt_dto.py` | **1 в 1 ПОДТВЕРЖДЕНО** |
| D3 → Orchestrator | `finpi_parser_photo/domain/dto/parse_receipt_dto.py` | **1 в 1 ПОДТВЕРЖДЕНО** |
| D1 → D2 | Наш дизайн | Гибкий |

---

## Последствия

1. **Любые изменения в D2→D3 или D3→Orchestrator требуют:**
   - Обновления в `finpi_parser_photo`
   - Обновления во всех зависимых сервисах
   - Adapter layer при необходимости

2. **Изменения в D1→D2:**
   - Не требуют согласования
   - Оптимизируем по необходимости

3. **При добавлении новых полей в жесткие контракты:**
   - Только опциональные поля
   - Только в конец структуры
   - С default значениями
