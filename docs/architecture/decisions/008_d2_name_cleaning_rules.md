# ADR-008: Правила очистки поля name в D2 (Parsing)

**Статус:** Утверждено  
**Контекст:** Определение правил очистки поля `name` перед передачей в D3

## Сводка решений

| Тип данных | Решение | Статус |
|------------|---------|--------|
| SKU / Коды товаров | УБИРАТЬ | Утверждено |
| Налоговые классы | УБИРАТЬ | Утверждено |
| Сокращения магазина (MC, JZN, F&G) | ОСТАВЛЯТЬ | Утверждено |
| Вес/размер в названии (400g, 3.5%) | ОСТАВЛЯТЬ | Утверждено |
| Категории магазина (HIT) | НЕ ПЕРЕДАВАТЬ в D3 | Утверждено |

---

## Контекст

D2 (Parsing) выполняется **КОДОМ** (не LLM).  
D3 (Categorization) выполняется **LLM** (не наша зона).

Задача D2: подготовить данные так, чтобы:
1. D3 получил чистое название для категоризации
2. Оркестратор получил полную информацию для пользователя/БД

---

## Утверждено

### 1. SKU / Коды товаров - УБИРАТЬ

**Причина:** Мусор для категоризации, не несет смысловой нагрузки.

| Магазин | Формат | Пример RAW | После очистки |
|---------|--------|------------|---------------|
| Aldi | 6 цифр в начале | `826945 Gouda 400g` | `Gouda 400g` |
| Shell | 6 цифр в начале | `050999 Twix Xtra 75g` | `Twix Xtra 75g` |
| HIT | (3 цифры) | `Lammkarree fr. (399)` | `Lammkarree fr.` |

**Паттерны для кода:**
```
^\d{4,6}\s+       # SKU в начале строки (4-6 цифр)
\s*\(\d{3,4}\)$   # SKU в скобках в конце строки
```

---

### 2. Налоговые классы - УБИРАТЬ

**Причина:** Техническая информация для налогообложения, не влияет на категоризацию.

| Магазин | Формат | Пример RAW | После очистки |
|---------|--------|------------|---------------|
| Lidl/Aldi/Edeka | Суффикс A/B | `Butter 250g A` | `Butter 250g` |
| Shell | Префикс +A/+B | `+A Twix Xtra` | `Twix Xtra` |
| Carrefour PL | Префикс A_/C_ | `A_TORBA RECYKLING` | `TORBA RECYKLING` |
| Carrefour PL | Префикс C_ | `C_JOG.D/P SKYR` | `JOG.D/P SKYR` |

**Паттерны для кода:**
```
\s+[A-Z]$         # Суффикс: одна буква в конце
^\+[A-Z]\s+       # Префикс: +A, +B в начале
^[A-Z]_           # Префикс: A_, B_, C_ в начале
```

**Важно:** Налоговый класс сохраняется в отдельном поле `tax_class`, не теряется.

---

## Утверждено

### 3. Сокращения магазина / Private Label / Бренды - ОСТАВЛЯТЬ

**Решение:** Оставлять как есть (Вариант A)

**Дата утверждения:** 2025-12-29

| Магазин | Сокращение | Расшифровка | Пример | Что уйдет в D3 |
|---------|------------|-------------|--------|----------------|
| Carrefour PL | `MC` | Marka Carrefour | `MC KOPEREK PĘCZEK` | MC KOPEREK PĘCZEK |
| Carrefour PL | `JZN` | Jedz Zdrowo Naturalnie | `JZN CZOSNEK SZTUK` | JZN CZOSNEK SZTUK |
| Carrefour PL | `SIMPL` | Simple | `SIMPL POMIDOR DAK` | SIMPL POMIDOR DAK |
| Aldi DE | `F&G` | Frisch & Gut (вероятно) | `F&G Häh Brustfil` | F&G Häh Brustfil |
| Consum ES | `CONSU` | Consum private label | `TIRAMISU 2X80 CONSU` | TIRAMISU 2X80 CONSU |

**Причины решения:**

1. **Не системное решение через код:**
   - Каждый магазин имеет свои сокращения
   - На 100+ локалях невозможно знать все сокращения
   - Оценка успеха очистки через код: ~50%
   - Высокий риск ложных срабатываний

2. **LLM в D3 справится:**
   - `MC KOPEREK` → LLM поймет что это укроп
   - Сокращения = шум в 2-3 токена, LLM их игнорирует
   - Оценка успеха: ~99%

3. **Сохранение информации для пользователя:**
   - Private label (MC, JZN) - полезная информация
   - Уходит в оркестратор и БД без потерь

**Принцип:** Системное решение > локальные хаки для каждого магазина

---

### 4. Вес/размер в названии - ОСТАВЛЯТЬ

**Решение:** Оставлять как есть

**Дата утверждения:** 2025-12-29

**Примеры:**

| RAW name | Что уйдет в D3 |
|----------|----------------|
| `Gouda 400g` | Gouda 400g |
| `Pfannengemüse 750g` | Pfannengemüse 750g |
| `H-Milch 3.5%` | H-Milch 3.5% |
| `Mineralwasser 6x1.5L` | Mineralwasser 6x1.5L |
| `Twix Xtra 75g` | Twix Xtra 75g |

**Причины решения:**

1. **Важно для категоризации:** Вес/размер может влиять на категорию
2. **Полезно для пользователя:** Информация сохраняется в БД
3. **Системное решение:** Не требует сложной логики очистки

---

### 5. Категории магазина в чеке (HIT) - НЕ ПЕРЕДАВАТЬ в D3

**Решение:** Не передавать в D3

**Дата утверждения:** 2025-12-29

**Примеры из HIT (отдельные строки на чеке):**
- `OBST & GEMÜSE`
- `LEBENSMITTEL`
- `GEKÜHLTE LEBENSMITTEL`
- `GETRÄNKE`
- `WEIN/SPIRITUOSEN/SEKT/CHAMPA`
- `PFAND/LEERGUT`

**Анализ:** Это НЕ часть `raw_name`, а отдельные строки-заголовки на чеке HIT.

**Решение:**
- D2 парсит категории как метаданные (для внутреннего использования)
- В D3 категории магазина НЕ передаются
- D3 сам определяет категорию через LLM + Constitution

**Причина:** Категоризация - ответственность D3, не D2

---

## Связанные документы

- ADR-007: D3 Categorization Overview
- ADR-006: D1-D2 Contract Design
- contracts/d2_parsing_dto.py

---

## История изменений

| Дата | Изменение |
|------|-----------|
| 2025-12-29 | Создан документ. Утверждены: SKU, налоговые классы |
| 2025-12-29 | Утверждено: Сокращения магазина - ОСТАВЛЯТЬ |
| 2025-12-29 | Утверждено: Вес/размер - ОСТАВЛЯТЬ |
| 2025-12-29 | Утверждено: Категории магазина (HIT) - НЕ ПЕРЕДАВАТЬ в D3 |
| 2025-12-29 | Документ полностью утвержден |
