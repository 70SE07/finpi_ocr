# ADR-011: Стратегия валидации (Checksum)

**Статус:** Утверждено  
**Вопросы плана:** Q4.1, Q4.2

---

## Контекст

D2 (Parsing) должен гарантировать что `SUM(items.total) == receipt_total`.

Вопросы:
1. Что делать если checksum не сходится?
2. Какой порог расхождения допустим?

---

## Решение

### Два контура работы системы

```
┌─────────────────────────────────────────────────────────────┐
│                     СТЕНД (Разработка)                      │
│                                                             │
│   photo/ (все чеки) → D1 → D2 → проверка checksum           │
│                                                             │
│   Mismatch? → Нормально, это процесс разработки             │
│            → Анализ → Новый паттерн → Улучшение D2          │
│            → Повтор до 100% success                         │
│                                                             │
│   Цель: 100% success на ВСЕХ чеках                          │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ 100% достигнуто
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                       ПРОДАКШЕН                             │
│                                                             │
│   Пользователь → фото → D1 → D2 → D3 → ответ СЕЙЧАС         │
│                                                             │
│   Mismatch = НЕВОЗМОЖЕН (всё покрыто на стенде)             │
│                                                             │
│   Если случился = КРИТИЧЕСКИЙ БАГ → откат → фикс на стенде  │
└─────────────────────────────────────────────────────────────┘
```

---

## Q4.1: Действия при checksum mismatch

### На стенде (разработка)

| Ситуация | Действие |
|----------|----------|
| Mismatch обнаружен | Нормальная часть разработки |
| Анализ | Почему не сошлось? Какой паттерн? |
| Улучшение | Добавить паттерн в D2 / locale config / store config |
| Проверка | Перезапустить, убедиться что сходится |
| Цель | 100% success на всех чеках из photo/ |

**Mismatch на стенде = точка роста системы.**

### В продакшене

| Ситуация | Действие |
|----------|----------|
| Mismatch обнаружен | КРИТИЧЕСКИЙ БАГ |
| Немедленно | Откат к стабильной версии |
| Анализ | Почему пропустили на стенде? |
| Фикс | На стенде, не в продакшене |
| Деплой | Только после 100% на стенде |

**Mismatch в продакшене = не должен случиться.**

### Почему так

```
Пользователь отправил фото чека
    ↓
Ждёт ответ СЕЙЧАС (не через час, не "обрабатывается")
    ↓
Система ДОЛЖНА выдать 100% корректный результат
    ↓
Это возможно ТОЛЬКО если мы заранее покрыли все паттерны
```

---

## Q4.2: Порог допустимого расхождения

### Утверждено: допуск на округление

| Порог | Допустимо? | Причина |
|-------|------------|---------|
| 0.00 | Идеал | Точное совпадение |
| 0.01-0.05 | **ДА** | Округление в магазине |
| > 0.05 | НЕТ | Реальная ошибка парсинга |

### Пример допустимого расхождения

```
Чек: 10 товаров по 1.333... EUR
Магазин округлил каждый: 1.33 EUR
Итого на чеке: 13.30 EUR

Наш расчёт:
  SUM(items) = 10 × 1.33 = 13.30 EUR ✓

Или если магазин считал иначе:
  SUM(items) = 13.33 EUR
  receipt_total = 13.30 EUR
  Разница = 0.03 EUR → ДОПУСТИМО
```

### Формула валидации

```python
def validate_checksum(items_sum: float, receipt_total: float) -> bool:
    TOLERANCE = 0.05  # допуск на округление
    difference = abs(items_sum - receipt_total)
    return difference <= TOLERANCE
```

---

## Процесс разработки

```
1. Берём чек из photo/
2. Прогоняем через D1 → D2
3. Проверяем checksum
4. Если mismatch:
   - Анализируем причину
   - Находим паттерн
   - Улучшаем D2 (код / config)
   - Повторяем
5. Если success:
   - Переходим к следующему чеку
6. Когда 100% на всех чеках:
   - Готовы к продакшену
```

---

## Критерий готовности к продакшену

```
✓ Все чеки из photo/ обработаны
✓ 100% checksum validation passed
✓ Все паттерны задокументированы
✓ Все locale/store configs созданы
```

**Только тогда система готова к продакшену.**

---

## Связанные документы

- `docs/PROJECT_VISION.md` - философия 100% качества
- `docs/architecture/decisions/009_d2_quality_guarantees.md` - гарантии D2
- `docs/patterns/` - документация паттернов

---

## История изменений

| Дата | Изменение |
|------|-----------|
| 2025-12-31 | Создан документ. Утверждены Q4.1 и Q4.2. |
