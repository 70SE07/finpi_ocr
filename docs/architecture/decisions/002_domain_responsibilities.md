# ADR-002: ЦКП доменов

**Статус:** Принято  
**Дата:** 2025-12-29  
**Вопрос плана:** Q1.1

---

## Контекст

Каждый домен должен иметь четкий ЦКП (Ценный Конечный Продукт) и гарантию качества.

---

## Вопрос

Какой ЦКП и гарантия у каждого домена?

---

## Решение

### Таблица ответственностей

| Домен | Этап | ЦКП | Гарантия |
|-------|------|-----|----------|
| **D1 (Extraction)** | Pre-OCR | Подготовленное изображение для OCR | Качество достаточное для OCR |
| **D1 (Extraction)** | OCR | Оцифрованный чек без потерь | **100% текста распознано без искажений** |
| **D2 (Parsing)** | Parsing | Структурированные данные (items + metadata), валидированные по checksum | **100% корректность данных** |
| **D3 (Categorization)** | Categorization | Категоризированный товар | Товар -> Категория -> Подкатегория |

**Почему 100%, а не 99.9%?** См. "Эффект одной буквы" в PROJECT_VISION.md

---

### D1 (Extraction) - детали

**Вход:** Изображение чека (любой формат, размер, качество)

**Этапы:**
1. Pre-OCR: resize, grayscale, compression
2. OCR: Google Vision API

**Выход:** `RawOCRResult` (контракт)

**ЦКП:** Эталонный цифровой слепок текста, очищенный от физических шумов носителя

**Гарантия:** 100% текста с чека оцифровано без потерь и искажений

**Критичность точности (эффект одной буквы):**

```
БЕКОН → БЕТОН (ошибка 1 буквы)
  D3 категоризирует: Стройматериалы вместо Продуктов
  Результат: БЕСПОЛЕЗЕН
```

Одна ошибка в D1 = неверная категория в D3 = обесцененный результат.

См. `PROJECT_VISION.md` → "Эффект одной буквы"

---

### D2 (Parsing) - детали

**Вход:** `RawOCRResult` (от D1)

**Этапы:**
1. Layout: восстановление структуры строк
2. Locale detection: определение страны/языка
3. Metadata extraction: магазин, дата, итог
4. Semantic extraction: товары (название, кол-во, цена, сумма)
5. Validation: checksum

**Выход:** `RawReceiptDTO` (контракт для D3)

**ЦКП:** Структурированные, валидированные данные чека

**Гарантия:** 
- Товар: название, количество, цена, единица измерения, сумма
- Валидация: `SUM(items.total_price) == receipt_total`
- Если checksum сошелся -> данные корректны на 100%

**Ключевой принцип: 100% success rate**

- Каждый чек ДОЛЖЕН быть обработан (нет исключений)
- "Невалидный чек" = БАГ СИСТЕМЫ, не проблема чека
- Понятия "отклоненный чек" НЕ СУЩЕСТВУЕТ
- D2 = гарант качества, D3 доверяет D2

См. ADR-009 для деталей.

---

### D3 (Categorization) - детали

**Вход:** `RawReceiptDTO` (от D2)

**Этапы:**
1. Конституция (правила)
2. Справочники
3. Акселераторы
4. AI

**Выход:** Категоризированные товары

**ЦКП:** Товар категоризирован: Товар -> Категория -> Подкатегория (L3, L4, L5...)

**Гарантия:** Определяется правилами D3 (вне скоупа этого проекта)

---

## Последствия

1. **Четкие границы** - каждый домен знает свой ЦКП
2. **Измеримость** - можно измерить качество каждого домена отдельно
3. **Контракты** - между доменами стабильные DTO
4. **Фокус** - D2 не думает о категоризации, D1 не думает о парсинге
