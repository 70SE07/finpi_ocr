# Алгоритм создания Ground Truth для AI

**Назначение:** Инструкция для AI-ассистента по созданию и валидации Ground Truth файлов.

---

## КРИТИЧЕСКИ ВАЖНО

```
Ground Truth = ЭТАЛОННЫЕ данные, созданные ЧЕЛОВЕКОМ
Ground Truth ≠ результат работы OCR/D1/любой машины
```

**AI читает ФИЗИЧЕСКИЙ ЧЕК (изображение) и записывает то, что ВИДИТ.**

---

## Алгоритм работы

### Шаг 1: Получить изображение чека

Пользователь присылает изображение чека. AI должен:
1. Внимательно прочитать ВСЁ на чеке
2. НЕ использовать OCR результаты
3. НЕ додумывать — только то, что видно

### Шаг 2: Извлечь данные

Прочитать с чека:

**Магазин:**
- Название
- Адрес
- ИНН/Tax ID (если есть)

**Метаданные:**
- Дата
- Время
- Валюта
- Способ оплаты
- Итоговая сумма (receipt_total)

**Позиции (items):**
Для каждой позиции:
- raw_name — название товара КАК НАПИСАНО на чеке
- quantity — количество
- unit_price — цена за единицу
- total_price — итоговая цена позиции
- unit — единица измерения (если не штуки: kg, Pár, etc.)

**Скидки:**
Скидки записываются как ОТДЕЛЬНЫЕ позиции с ОТРИЦАТЕЛЬНОЙ ценой:
```json
{"raw_name": "Знижка товар X", "quantity": 1, "unit_price": -20.00, "total_price": -20.00, "is_discount": true}
```

### Шаг 3: Проверить Checksum

**ОБЯЗАТЕЛЬНАЯ ПРОВЕРКА:**

```
sum(item.total_price for item in items) == receipt_total
```

Допустимая погрешность: < 0.01

Если не сходится:
1. Перепроверить все позиции
2. Убедиться что скидки включены как отрицательные значения
3. Проверить округления

### Шаг 4: Создать JSON файл

**Структура папок:**

```
docs/ground_truth/
├── de_DE/
│   ├── 001_de_DE_lidl_IMG_1292.json
│   ├── 002_de_DE_dm_IMG_1252.json
│   └── ...
├── cs_CZ/
│   ├── 001_cs_CZ_hornbach_IMG_001.json
│   └── ...
├── th_TH/
│   ├── 001_th_TH_7eleven_IMG_2461.json
│   └── ...
└── ...
```

**Формат имени файла:**
```
{ID}_{locale}_{store}_{image_name}.json
```

**Правила нумерации ID:**
- ID — это порядковый номер ВНУТРИ папки локали (001, 002, 003...)
- Каждая локаль начинается с 001
- Перед созданием нового файла — посмотри какой последний ID в папке локали

**Пример:** Для чешского чека смотрим папку `cs_CZ/`:
- Если там уже есть `001_cs_CZ_hornbach_IMG_001.json`
- Следующий файл будет `002_cs_CZ_...`

**Структура JSON:**

```json
{
  "id": "001",
  "source_file": "data/input/cz_001.jpeg",
  "locale": "cs_CZ",
  "store": {
    "name": "Hornbach",
    "address": "адрес магазина",
    "tax_id": "ИНН если есть"
  },
  "metadata": {
    "date": "28.10.2025",
    "time": "18:05:26",
    "currency": "CZK",
    "payment_method": "Cash",
    "receipt_total": 1135.78
  },
  "items": [
    {"raw_name": "Название товара", "quantity": 1, "unit_price": 20.00, "total_price": 20.00},
    {"raw_name": "Товар на вес", "quantity": 0.246, "unit": "kg", "unit_price": 213.00, "total_price": 52.40},
    {"raw_name": "Скидка", "quantity": 1, "unit_price": -10.00, "total_price": -10.00, "is_discount": true}
  ]
}
```

**ВАЖНО:** Поле `"id"` должно совпадать с номером в имени файла!
- Файл: `001_cs_CZ_hornbach_IMG_001.json` → `"id": "001"`
- Файл: `042_de_DE_sbtankstelle_IMG_1352.json` → `"id": "042"`

### Шаг 5: Верификация

После создания файла выполнить проверку:

```python
import json
with open('path/to/ground_truth.json') as f:
    gt = json.load(f)
items_sum = sum(item['total_price'] for item in gt['items'])
print(f"Items sum: {items_sum:.2f}")
print(f"Receipt total: {gt['metadata']['receipt_total']}")
print(f"Discrepancy: {abs(items_sum - gt['metadata']['receipt_total']):.2f}")
print(f"Status: {'OK' if abs(items_sum - gt['metadata']['receipt_total']) < 0.01 else 'ERROR'}")
```

**Результат должен быть: Status: OK**

---

## Особые случаи

### Округление (Чехия, и др.)

Если на чеке есть округление:
```
SOUČET: 1135,78
Zaokrouhlení: 0,22
K zaplacení: 1136,00
```

Записать:
- `receipt_total`: 1135.78 (фактическая сумма БЕЗ округления)
- `rounding`: 0.22 (в metadata)
- `amount_paid`: 1136.00 (в metadata)

### Скидки в отдельном блоке

Если на чеке скидки показаны отдельно:
```
Subtotal: 783.25
Скидка 1: -20.00
Скидка 2: -5.00
Итого: 758.25
```

Записать скидки как items с отрицательной ценой. Тогда:
```
sum(items) = 783.25 + (-20.00) + (-5.00) = 758.25 = receipt_total ✓
```

### Товары с нулевой ценой

Марки, купоны, бонусы по 0.00 — можно НЕ включать в items, но указать в `notes`.

### Весовой товар

```json
{"raw_name": "GAMBON GRANDE", "quantity": 0.580, "unit": "kg", "total_price": 7.51}
```

Для весового товара `unit_price` может отсутствовать если не указан на чеке.

---

## Чеклист перед сохранением

- [ ] Все позиции с чека записаны
- [ ] Скидки записаны как отрицательные позиции
- [ ] raw_name точно как на чеке (с сокращениями, как есть)
- [ ] Checksum сходится (Status: OK)
- [ ] receipt_total = фактическая сумма (без округления)
- [ ] Валюта указана правильно
- [ ] locale соответствует стране чека

---

## Пример диалога

**Пользователь:** @data/input/IMG_1234.jpeg работаем над ground_truth по этому чеку

**AI:**
1. Смотрит на изображение
2. Читает все позиции
3. Создаёт JSON
4. Запускает проверку checksum
5. Показывает результат: Items sum, Receipt total, Status

**Если Status: ERROR** — перепроверить и исправить

**Если Status: OK** — Ground Truth готов

---

## Запрещено

- Использовать результаты OCR для создания Ground Truth
- Додумывать названия товаров
- Игнорировать скидки
- Записывать receipt_total с округлением если это ломает checksum
- Пропускать позиции

---

## КРИТИЧЕСКИ ВАЖНО: Правила записи raw_name

### Правило 1: КОПИРУЙ, НЕ ИСПРАВЛЯЙ

```
raw_name = ТОЧНАЯ КОПИЯ текста с чека
```

**ЗАПРЕЩЕНО:**
- Исправлять "ошибки"
- Добавлять пробелы
- Убирать пробелы
- Менять регистр
- "Улучшать" написание

**Если на чеке написано `БИСКВ.МИРАЖ` — пиши `БИСКВ.МИРАЖ`**
**Если на чеке написано `БИСКВ. МИРАЖ` — пиши `БИСКВ. МИРАЖ`**

### Правило 2: Кириллица vs Латиница

**ВНИМАНИЕ! Эти буквы выглядят ОДИНАКОВО но это РАЗНЫЕ символы:**

| Кириллица | Латиница |
|-----------|----------|
| К | K |
| Е | E |
| О | O |
| Р | P |
| С | C |
| А | A |
| М | M |
| Т | T |
| Х | X |

**Правило:** Если слово на чеке написано КИРИЛЛИЦЕЙ — пиши КИРИЛЛИЦЕЙ.

Примеры:
- `КРЕО` — это К-Р-Е-О (кириллица), НЕ K-R-E-O (латиница)
- `BILLA` — это латиница (английское название бренда)
- `ПИЛЕШКИ` — это кириллица

### Правило 3: Похожие буквы

**НЕ ПУТАЙ:**
- `И` и `Й` — это РАЗНЫЕ буквы
- `Ь` и `Ъ` — это РАЗНЫЕ буквы
- `Ш` и `Щ` — это РАЗНЫЕ буквы

**Если на чеке `ЛИНГУИНИ` — пиши `ЛИНГУИНИ`**
**Если на чеке `ЛИНГУЙНИ` — пиши `ЛИНГУЙНИ`**

НЕ ДОДУМЫВАЙ какое написание "правильнее".

### Правило 4: При сомнениях

Если не уверен как написано на чеке:
1. Увеличь изображение
2. Посмотри на соседние буквы для контекста
3. Если всё равно не уверен — напиши как видишь и добавь комментарий

```json
{"raw_name": "КРЕО ТОН ФИЛЕ", "note": "первые буквы могут быть латиницей"}
```

### Тест на понимание

**Вопрос:** На чеке написано `BARILLA ЛИНГУИНИ`. Как записать?

**Правильно:** `"raw_name": "BARILLA ЛИНГУИНИ"`

**Неправильно:** 
- `"BARILLA ЛИНГУЙНИ"` — изменил И на Й
- `"БАРИЛЛА ЛИНГУИНИ"` — перевёл на кириллицу
- `"Barilla Лингуини"` — изменил регистр

---

## Путь сохранения

```
docs/ground_truth/{locale}/{ID}_{locale}_{store}_{image_name}.json
```

**Примеры:**
- `docs/ground_truth/de_DE/008_de_DE_aldi_IMG_1724.json`
- `docs/ground_truth/cs_CZ/001_cs_CZ_hornbach_IMG_001.json`
- `docs/ground_truth/th_TH/001_th_TH_7eleven_IMG_2461.json`

**Алгоритм определения ID для нового файла:**
1. Определи локаль чека (de_DE, cs_CZ, th_TH, etc.)
2. Загляни в папку `docs/ground_truth/{locale}/`
3. Найди файл с максимальным ID
4. Новый ID = max + 1 (с ведущими нулями: 001, 002, 042...)

---

*Документ создан на основе практики валидации Ground Truth для проекта Finpi OCR.*
