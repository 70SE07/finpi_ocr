---
description: Алгоритм ручной верификации OCR (Строгий протокол)
---

Этот воркфлоу описывает ЕДИНСТВЕННО ВЕРНЫЙ способ проведения верификации OCR.
Агент ОБЯЗАН строго следовать этому шаблону, не добавляя отсебятины.

### ЭТАП 1: Ground Truth (Что видит глаз)

1. Проверь наличие `data/output/<ИмяФайла>/ground_truth/ground_truth.md`.
2. **Если файл есть**: Переходи к этапу 2.
3. **Если файла нет**:
   - Открой оригинал чека в `data/input/`.
   - Изучи его визуально.
   - Создай файл `ground_truth.md` по шаблону.
4. Отправь в чат **ПЕРВОЕ** сообщение (даже если файл уже был).

### ЭТАП 2: Raw OCR (Что видит робот)

1. Проверь наличие `data/output/<ИмяФайла>/raw_ocr/<ИмяФайла>_raw.json`.
2. **Если файл есть**: Проверь, не изменились ли параметры Pre-OCR. Если нет — используй готовый.
3. **Если файла нет**: Запусти `python scripts/run_pipeline.py data/input/<ИмяФайла>`.
4. Сравни `full_text` и структуру блоков с твоей таблицей из Этапа 1.

### ЭТАП 3: Проверка модулей (Layout & Extraction)

1. Проверь наличие файлов в `post_ocr/layout/` и `post_ocr/items/`.
2. Проверь время их изменения. Если они свежее, чем изменения в коде соответствующих модулей — используй их.

### ЭТАП 4: Post-OCR (Финальный DTO)

1. Проверь финальный результат в `post_ocr/final/`.
2. Если всё актуально — отправь в чат **ВТОРОЕ** сообщение.

```markdown
## Анализ <ИмяФайла>

### Что я вижу на чеке (Ground Truth):

| # | Товар | Цена | Qty | Сумма |
|---|-------|------|-----|-------|
| 1 | <Точное название> | <Цена> € | <Кол-во> | <Итог> € |
| 2 | ... | ... | ... | ... |
| | **Итого** | | | **<ОбщаяСумма>** € |

---

### Анализ по категориям:
*   **Всего товаров**: <Число>
*   **Скидки/Preisvorteil**: <Число позиций>
*   **Сумма чека**: <Сумма> €
*   **Сумма скидок**: <Сумма> €
```

---

### ЭТАП 2: Raw OCR (Что видит робот)

1. Запусти скрипт пайплайна для этого файла:
   `python scripts/run_pipeline.py data/input/<ИмяФайла>`
2. Открой полученный "сырой" JSON:
   `data/output/<ИмяФайла>/raw_ocr/<ИмяФайла>_raw.json`
3. Сравни `full_text` и структуру блоков с твоей таблицей из Этапа 1.

### ЭТАП 3: Проверка модулей (Layout & Extraction)

1. **Layout**: Если в Raw OCR текст есть, а строки в финале кривые — проверь `data/output/<ИмяФайла>/post_ocr/layout/<ИмяФайла>_layout.json`. Текст должен быть разбит на логические строки.
2. **Extraction**: Если строки верные, но товаров нет — проверь `data/output/<ИмяФайла>/post_ocr/items/<ИмяФайла>_items.json`. Это результат работы парсера.

### ЭТАП 4: Post-OCR (Финальный DTO)

1. Открой финальный результат:
   `data/output/<ИмяФайла>/post_ocr/final/<ИмяФайла>_result.json`
2. Проверь наличие и корректность массива `items` (Товары).
3. Отправь в чат **ВТОРОЕ** сообщение точно по этому шаблону:

```markdown
### Что в Raw OCR (Сверка):

| # | Товар (OCR) | Цена (OCR) | Статус | Отличия / Ошибки |
|---|---|---|---|---|
| 1 | <ТекстOCR> | <ЦенаOCR> | ✅ OK / ⚠️ WARN / ❌ FAIL | <Пусто или описание бага> |
| 2 | ... | ... | ... | ... |

### Статус модулей:
- **Layout**: ✅ OK / ❌ FAIL
- **Extraction**: ✅ OK / ❌ FAIL

### Вывод:
<Краткий итог: На каком этапе произошел сбой и почему>
```