---
description: Протокол Атомарной Разработки (Modular First & SRP)
---

# Протокол Атомарной Разработки (Modular First)

Этот документ — техническое воплощение [Философии Проекта](file:///Users/sergejevsukov/Downloads/Finpi_OCR/.agent/philosophy.md).
Агент ОБЯЗАН следовать этим правилам при расширении функционала.

## 1. Принцип Single Responsibility (SRP) на уровне элементов

Мы не просто делим код на функции, мы создаем **независимые функциональные элементы**.
- **Правило**: Один файл = Одна бизнес-задача (напр. поиск цены, поиск налога, валидация математики).
- **Запрет**: Запрещено добавлять логику «А» в модуль «Б», даже если это кажется «удобным быстрым фиксом».
- **Масштабируемость**: Если нужна новая проверка — создавай новый файл в соответствующем модуле (напр. `src/post_ocr/extraction/new_checker.py`).

## 2. ЦКП как Религия (Ценный Конечный Продукт)

Каждый функциональный элемент обязан возвращать четкий, проверяемый результат — **ЦКП**.
- Элемент не может просто «что-то поменять в памяти». 
- Он принимает входные данные -> выполняет трансформацию -> возвращает объект/значение ЦКП.
- Если ЦКП не может быть сформирован (ошибка/пусто) — элемент возвращает явный `None` или объект со статусом `failed/skipped`.

## 3. Принцип Traceability (След Анализа)

Основной пайплайн (Оркестратор) обязан собирать ЦКП от всех элементов в единый «Trace» (След).
- **Зачем**: Чтобы при провале верификации мы могли мгновенно понять, какой именно «кирпичик» в фундаменте сломался.
- **Реализация**: Каждый элемент в `Extraction` добавляет свои результаты в JSON-объект `trace`, который сохраняется на диск в `data/output/<ID>/post_ocr/items/`.

## 4. Алгоритм добавления нового функционала

Если нужно добавить новый этап анализа (напр. поиск артикулов SKU):

1. **Создание Элемента**: Создай `sku_parser.py` в `src/post_ocr/extraction/`.
2. **Реализация ЦКП**: Опиши класс, который возвращает `SkuResult` (номер артикула + уверенность).
3. **Регистрация в __init__**: Экспортируй элемент.
4. **Интеграция в Оркестратор**: Добавь вызов элемента в `SemanticExtractor.process` и сохрани его ЦКП в `trace`.

---

## 5. Работа с Legacy (Векторный подход)

При переносе кода из `old_project`:
- **Анализ**: Пойми логику (Вектор).
- **Рефакторинг**: Нарежь логику на атомарные функции.
- **Интеграция**: Оберни функции в модули с ЦКП и Trace.
- **Очистка**: Удаляй за собой старый код, как только он «переплавлен» в новый.

**Соблюдение этого протокола гарантирует, что проект останется чистым и понятным.**
